(function(){var t={};t.Matrix3=function(t,i,o,e,s,a,n,r,c){this.e00=t||0,this.e01=i||0,this.e02=o||0,this.e10=e||0,this.e11=s||0,this.e12=a||0,this.e20=n||0,this.e21=r||0,this.e22=c||0},t.Matrix3.prototype={identity:function(){this.e00=1,this.e01=0,this.e02=0,this.e10=0,this.e11=1,this.e12=0,this.e20=0,this.e21=0,this.e22=1},fromMatrix4:function(t){this.e00=t.e00,this.e01=t.e01,this.e02=t.e02,this.e10=t.e10,this.e11=t.e11,this.e12=t.e12,this.e20=t.e20,this.e21=t.e21,this.e22=t.e22},fromQuaternion:function(t){var i=t.x+t.x,o=t.y+t.y,e=t.z+t.z,s=t.x*i,a=t.x*o,n=t.x*e,r=t.y*o,c=t.y*e,h=t.z*e,l=t.w*i,p=t.w*o,_=t.w*e;this.e00=1-(r+h),this.e10=a+_,this.e20=n-p,this.e01=a-_,this.e11=1-(s+h),this.e21=c+l,this.e02=n+p,this.e12=c-l,this.e22=1-(s+r)},transformVector3:function(t){var i=t.x,o=t.y,e=t.z;t.x=this.e00*i+this.e01*o+this.e02*e,t.y=this.e10*i+this.e11*o+this.e12*e,t.z=this.e20*i+this.e21*o+this.e22*e},transformVector3Into:function(t,i){i.x=this.e00*t.x+this.e01*t.y+this.e02*t.z,i.y=this.e10*t.x+this.e11*t.y+this.e12*t.z,i.z=this.e20*t.x+this.e21*t.y+this.e22*t.z},transposeInto:function(t){t.e00=this.e00,t.e10=this.e01,t.e20=this.e02,t.e01=this.e10,t.e11=this.e11,t.e21=this.e12,t.e02=this.e20,t.e12=this.e21,t.e22=this.e22},invert:function(){var t,i=this.e00,o=this.e01,e=this.e02,s=this.e10,a=this.e11,n=this.e12,r=this.e20,c=this.e21,h=this.e22,l=h*a-n*c,p=-h*s+n*r,_=c*s-a*r,b=i*l+o*p+e*_;return b?(t=1/b,this.e00=l*t,this.e01=(-h*o+e*c)*t,this.e02=(n*o-e*a)*t,this.e10=p*t,this.e11=(h*i-e*r)*t,this.e12=(-n*i+e*s)*t,this.e20=_*t,this.e21=(-c*i+o*r)*t,this.e22=(a*i-o*s)*t,!0):!0},invertInto:function(t){var i,o=this.e00,e=this.e01,s=this.e02,a=this.e10,n=this.e11,r=this.e12,c=this.e20,h=this.e21,l=this.e22,p=l*n-r*h,_=-l*a+r*c,b=h*a-n*c,u=o*p+e*_+s*b;return u?(i=1/u,t.e00=p*i,t.e01=(-l*e+s*h)*i,t.e02=(r*e-s*n)*i,t.e10=_*i,t.e11=(l*o-s*c)*i,t.e12=(-r*o+s*a)*i,t.e20=b*i,t.e21=(-h*o+e*c)*i,t.e22=(n*o-e*a)*i,!0):!1},multiply:function(t){var i=this.e00,o=this.e01,e=this.e02,s=this.e10,a=this.e11,n=this.e12,r=this.e20,c=this.e21,h=this.e22,l=t.e00,p=t.e01,_=t.e02,b=t.e10,u=t.e11,f=t.e12,d=t.e20,m=t.e21,y=t.e22;this.e00=l*i+b*o+d*e,this.e10=l*s+b*a+d*n,this.e20=l*r+b*c+d*h,this.e01=p*i+u*o+m*e,this.e11=p*s+u*a+m*n,this.e21=p*r+u*c+m*h,this.e02=_*i+f*o+y*e,this.e12=_*s+f*a+y*n,this.e22=_*r+f*c+y*h},multiplyFrom:function(t,i){var o=t.e00,e=t.e01,s=t.e02,a=t.e10,n=t.e11,r=t.e12,c=t.e20,h=t.e21,l=t.e22,p=i.e00,_=i.e01,b=i.e02,u=i.e10,f=i.e11,d=i.e12,m=i.e20,y=i.e21,j=i.e22;this.e00=p*o+u*e+m*s,this.e10=p*a+u*n+m*r,this.e20=p*c+u*h+m*l,this.e01=_*o+f*e+y*s,this.e11=_*a+f*n+y*r,this.e21=_*c+f*h+y*l,this.e02=b*o+d*e+j*s,this.e12=b*a+d*n+j*r,this.e22=b*c+d*h+j*l}},t.Matrix4=function(){this.e00=0,this.e01=0,this.e02=0,this.e03=0,this.e10=0,this.e11=0,this.e12=0,this.e13=0,this.e20=0,this.e21=0,this.e22=0,this.e23=0,this.e30=0,this.e31=0,this.e32=0,this.e33=0},t.Matrix4.prototype={identity:function(){this.e00=1,this.e01=0,this.e02=0,this.e03=0,this.e10=0,this.e11=1,this.e12=0,this.e13=0,this.e20=0,this.e21=0,this.e22=1,this.e23=0,this.e30=0,this.e31=0,this.e32=0,this.e33=1},makeTransform:function(t,i){var o=t.x+t.x,e=t.y+t.y,s=t.z+t.z,a=t.x*o,n=t.x*e,r=t.x*s,c=t.y*e,h=t.y*s,l=t.z*s,p=t.w*o,_=t.w*e,b=t.w*s;this.e00=1-(c+l),this.e10=n+b,this.e20=r-_,this.e30=0,this.e01=n-b,this.e11=1-(a+l),this.e21=h+p,this.e31=0,this.e02=r+_,this.e12=h-p,this.e22=1-(a+c),this.e32=0,this.e03=i.x,this.e13=i.y,this.e23=i.z,this.e33=1},transformVector3:function(t){var i=t.x,o=t.y,e=t.z;t.x=this.e00*i+this.e01*o+this.e02*e+this.e03,t.y=this.e10*i+this.e11*o+this.e12*e+this.e13,t.z=this.e20*i+this.e21*o+this.e22*e+this.e23},transformVector3Into:function(t,i){i.x=this.e00*t.x+this.e01*t.y+this.e02*t.z+this.e03,i.y=this.e10*t.x+this.e11*t.y+this.e12*t.z+this.e13,i.z=this.e20*t.x+this.e21*t.y+this.e22*t.z+this.e23},rotateVector3:function(t){var i=t.x,o=t.y,e=t.z;t.x=this.e00*i+this.e01*o+this.e02*e,t.y=this.e10*i+this.e11*o+this.e12*e,t.z=this.e20*i+this.e21*o+this.e22*e},rotateVector3Into:function(t,i){i.x=this.e00*t.x+this.e01*t.y+this.e02*t.z,i.y=this.e10*t.x+this.e11*t.y+this.e12*t.z,i.z=this.e20*t.x+this.e21*t.y+this.e22*t.z},invert:function(){var t,i=this.e00,o=this.e01,e=this.e02,s=this.e03,a=this.e10,n=this.e11,r=this.e12,c=this.e13,h=this.e20,l=this.e21,p=this.e22,_=this.e23,b=this.e30,u=this.e31,f=this.e32,d=this.e33,m=i*n-o*a,y=i*r-e*a,j=i*c-s*a,w=o*r-e*n,x=o*c-s*n,v=e*c-s*r,g=h*u-l*b,z=h*f-p*b,V=h*d-_*b,B=l*f-p*u,S=l*d-_*u,C=p*d-_*f,P=m*C-y*S+j*B+w*V-x*z+v*g;return P?(t=1/P,this.e00=(n*C-r*S+c*B)*t,this.e01=(-o*C+e*S-s*B)*t,this.e02=(u*v-f*x+d*w)*t,this.e03=(-l*v+p*x-_*w)*t,this.e10=(-a*C+r*V-c*z)*t,this.e11=(i*C-e*V+s*z)*t,this.e12=(-b*v+f*j-d*y)*t,this.e13=(h*v-p*j+_*y)*t,this.e20=(a*S-n*V+c*g)*t,this.e21=(-i*S+o*V-s*g)*t,this.e22=(b*x-u*j+d*m)*t,this.e23=(-h*x+l*j-_*m)*t,this.e30=(-a*B+n*z-r*g)*t,this.e31=(i*B-o*z+e*g)*t,this.e32=(-b*w+u*y-f*m)*t,this.e33=(h*w-l*y+p*m)*t,!0):!1},invertInto:function(t){var i,o=this.e00,e=this.e10,s=this.e20,a=this.e30,n=this.e01,r=this.e11,c=this.e21,h=this.e31,l=this.e02,p=this.e12,_=this.e22,b=this.e32,u=this.e03,f=this.e13,d=this.e23,m=this.e33,y=o*r-e*n,j=o*c-s*n,w=o*h-a*n,x=e*c-s*r,v=e*h-a*r,g=s*h-a*c,z=l*f-p*u,V=l*d-_*u,B=l*m-b*u,S=p*d-_*f,C=p*m-b*f,P=_*m-b*d,O=y*P-j*C+w*S+x*B-v*V+g*z;return O?(i=1/O,t.e00=(r*P-c*C+h*S)*i,t.e10=(-e*P+s*C-a*S)*i,t.e20=(f*g-d*v+m*x)*i,t.e30=(-p*g+_*v-b*x)*i,t.e01=(-n*P+c*B-h*V)*i,t.e11=(o*P-s*B+a*V)*i,t.e21=(-u*g+d*w-m*j)*i,t.e31=(l*g-_*w+b*j)*i,t.e02=(n*C-r*B+h*z)*i,t.e12=(-o*C+e*B-a*z)*i,t.e22=(u*v-f*w+m*y)*i,t.e32=(-l*v+p*w-b*y)*i,t.e03=(-n*S+r*V-c*z)*i,t.e13=(o*S-e*V+s*z)*i,t.e23=(-u*x+f*j-d*y)*i,t.e33=(l*x-p*j+_*y)*i,void 0):!1}},t.Quaternion=function(t,i,o,e){this.x=null!=t?t:0,this.y=null!=i?i:0,this.z=null!=o?o:0,this.w=null!=e?e:1,this.normalize()},t.Quaternion.prototype={set:function(t,i,o,e){this.x=t,this.y=i,this.z=o,this.w=e},multiply:function(t){var i=this.x,o=this.y,e=this.z,s=this.w,a=t.x,n=t.y,r=t.z,c=t.w;this.x=i*c+s*a+o*r-e*n,this.y=o*c+s*n+e*a-i*r,this.z=e*c+s*r+i*n-o*a,this.w=s*c-i*a-o*n-e*r},multiplyQuaternions:function(t,i){this.x=t.x*i.w+t.w*i.x+t.y*i.z-t.z*i.y,this.y=t.y*i.w+t.w*i.y+t.z*i.x-t.x*i.z,this.z=t.z*i.w+t.w*i.z+t.x*i.y-t.y*i.x,this.w=t.w*i.w-t.x*i.x-t.y*i.y-t.z*i.z},normalize:function(){var t=this.x,i=this.y,o=this.z,e=this.w,s=Math.sqrt(t*t+i*i+o*o+e*e);0===s?this.x=this.y=this.z=this.w=0:(s=1/s,this.x*=s,this.y*=s,this.z*=s,this.w*=s)},invertQuaternion:function(t){var i=t.x,o=t.y,e=t.z,s=t.w,a=i*i+o*o+e*e+s*s;if(0===a)this.x=this.y=this.z=this.w=0;else{var n=-1/a;this.x=t.x*n,this.y=t.y*n,this.z=t.z*n,this.w=t.w*-n}},transformVector3:function(t){var i=t.x,o=t.y,e=t.z,s=this.x,a=this.y,n=this.z,r=this.w,c=r*i+a*e-n*o,h=r*o+n*i-s*e,l=r*e+s*o-a*i,p=-s*i-a*o-n*e;t.x=c*r+p*-s+h*-n-l*-a,t.y=h*r+p*-a+l*-s-c*-n,t.z=l*r+p*-n+c*-a-h*-s},transformVector3Into:function(t,i){var o=t.x,e=t.y,s=t.z,a=this.x,n=this.y,r=this.z,c=this.w,h=c*o+n*s-r*e,l=c*e+r*o-a*s,p=c*s+a*e-n*o,_=-a*o-n*e-r*s;i.x=h*c+_*-a+l*-r-p*-n,i.y=l*c+_*-n+p*-a-h*-r,i.z=p*c+_*-r+h*-n-l*-a}},t.Vector3=function(t,i,o){this.x=t||0,this.y=i||0,this.z=o||0},t.Vector3.prototype={set:function(t,i,o){this.x=t,this.y=i,this.z=o},copy:function(t){this.x=t.x,this.y=t.y,this.z=t.z},add:function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},addVectors:function(t,i){this.x=t.x+i.x,this.y=t.y+i.y,this.z=t.z+i.z},subtract:function(t){this.x-=t.x,this.y-=t.y,this.z-=t.z},subtractVectors:function(t,i){this.x=t.x-i.x,this.y=t.y-i.y,this.z=t.z-i.z},multiply:function(t){this.x*=t.x,this.y*=t.y,this.z*=t.z},multiplyVectors:function(t,i){this.x=t.x*i.x,this.y=t.y*i.y,this.z=t.z*i.z},scale:function(t){this.x*=t,this.y*=t,this.z*=t},scaleVector:function(t,i){this.x=t.x*i,this.y=t.y*i,this.z=t.z*i},lengthSquared:function(){return this.dot(this)},length:function(){return Math.sqrt(this.lengthSquared())},normalize:function(){var t=this.length();0===t?this.x=this.y=this.z=0:this.scale(1/t)},normalizeVector:function(t){this.copy(t),this.normalize()},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},cross:function(t){var i=this.x,o=this.y,e=this.z;this.x=o*t.z-e*t.y,this.y=e*t.x-i*t.z,this.z=i*t.y-o*t.x},crossVectors:function(t,i){this.x=t.y*i.z-t.z*i.y,this.y=t.z*i.x-t.x*i.z,this.z=t.x*i.y-t.y*i.x},distanceTo:function(t){var i=t.x-this.x,o=t.y-this.y,e=t.z-this.z;return Math.sqrt(i*i+o*o+e*e)}},t.EPSILON=1e-5;var i=new t.Vector3,o=new t.Vector3,e=new t.Vector3,s=new t.Quaternion,a=new t.Quaternion,n=new t.Matrix3,r=new t.Matrix3;t.EventEmitter=function(){},t.EventEmitter.prototype={addListener:function(t,i){null==this.listeners[t]&&(this.listeners[t]=[]),-1===this.listeners[t].indexOf(i)&&this.listeners[t].push(i)},removeListener:function(t,i){null==this.listeners[t]&&(this.listeners[t]=[]);var o=this.listeners[t].indexOf(i);-1!==o&&this.listeners[t].splice(o,1)},removeAllListeners:function(){for(var t=Object.keys(this.listeners),i=0;t.length>i;i++)this.listeners[t[i]].length=0},emit:function(t){var i,o=Array.prototype.slice.call(arguments,1);if(this.listeners[t]instanceof Array)for(var e=this.listeners[t].slice(),s=0;e.length>s;s++)if(i=e[s].apply(this,o),i===!1)return!1}},t.EventEmitter.apply=function(i){i.prototype.addListener=t.EventEmitter.prototype.addListener,i.prototype.removeListener=t.EventEmitter.prototype.removeListener,i.prototype.removeAllListeners=t.EventEmitter.prototype.removeAllListeners,i.prototype.emit=t.EventEmitter.prototype.emit},t.AABB=function(i,o){this.min=i||new t.Vector3,this.max=o||new t.Vector3},t.AABB.prototype.transform=function(){var o=new t.Vector3,e=new t.Vector3,s=new t.Vector3,a=new t.Vector3,n=new t.Matrix3;return function(t,r){o.subtractVectors(t.max,t.min),o.scale(.5),e.addVectors(t.max,t.min),e.scale(.5),r.transformVector3Into(e,s),n.e00=Math.abs(r.e00),n.e01=Math.abs(r.e01),n.e02=Math.abs(r.e02),n.e10=Math.abs(r.e10),n.e11=Math.abs(r.e11),n.e12=Math.abs(r.e12),n.e20=Math.abs(r.e20),n.e21=Math.abs(r.e21),n.e22=Math.abs(r.e22),i.x=n.e00,i.y=n.e10,i.z=n.e20,a.x=o.dot(i),i.x=n.e01,i.y=n.e11,i.z=n.e21,a.y=o.dot(i),i.x=n.e02,i.y=n.e12,i.z=n.e22,a.z=o.dot(i),this.min.subtractVectors(s,a),this.max.addVectors(s,a)}}(),t.AABB.prototype.intersects=function(t){return this.max.x<t.min.x||this.max.y<t.min.y||this.max.z<t.min.z||this.min.x>t.max.x||this.min.y>t.max.y||this.min.z>t.max.z?!1:!0},t.AABB.prototype.testRayIntersect=function(){var i,o,e,s,a,n,r=new t.Vector3;return function(c,h){i=0,r.subtractVectors(h,c),o=r.length(),r.scale(1/o);for(var l=0;3>l;l++){n=0===l?"x":1===l?"y":"z";var p=0===l?this.min.x:1===l?this.min.y:this.min.z,_=0===l?this.max.x:1===l?this.max.y:this.max.z;if(Math.abs(r[n])<t.EPSILON){if(p>c[n]||c[n]>_)return!1}else if(e=1/r[n],s=(p-c[n])*e,a=(_-c[n])*e,s>a&&(e=s,s=a,a=e),i=Math.max(i,s),o=Math.min(o,a),i>o)return!1}return!0}}(),t.BasicBroadphase=function(){this.bodies=[],this.collision_pairs=[]},t.BasicBroadphase.prototype.addBody=function(t){this.bodies.push(t)},t.BasicBroadphase.prototype.removeBody=function(t){var i,o=this.bodies.length;for(i=0;o>i;i++)if(this.bodies[i]===t){this.bodies.splice(i,1);break}},t.BasicBroadphase.prototype.predictContactPairs=function(){var t,i,o,e,s=this.bodies.length;for(this.collision_pairs.length=0,t=0;s>t;t++)for(o=this.bodies[t],i=0;s>i;i++)if(!(i>=t)&&(e=this.bodies[i],1/0!==o.mass||1/0!==e.mass)){if(0!==o.collision_mask)if(0===(1&o.collision_mask)){if(0!==(o.collision_mask&e.collision_groups))continue}else if(0===(o.collision_mask&e.collision_groups))continue;if(0!==e.collision_mask)if(0===(1&e.collision_mask)){if(0!==(e.collision_mask&o.collision_groups))continue}else if(0===(e.collision_mask&o.collision_groups))continue;this.mightIntersect(o,e)&&this.collision_pairs.push([o,e])}},t.BasicBroadphase.prototype.intersectsWith=function(t){var i,o,e=this.bodies.length,s=[];for(i=0;e>i;i++)o=this.bodies[i],t!==o&&this.mightIntersect(t,o)&&s.push(o);return s},t.BasicBroadphase.prototype.mightIntersect=function(t,i){return t.aabb.intersects(i.aabb)},t.BasicBroadphase.prototype.rayIntersect=function(t,i){var o,e,s=this.bodies.length,a=[];for(o=0;s>o;o++)e=this.bodies[o],e.aabb.testRayIntersect(t,i)&&e.rayIntersect(t,i,a);return a},t.BoxSphere=function(s,a){var n,r,c=s.shape instanceof t.SphereShape?s:a,h=s.shape instanceof t.SphereShape?a:s;return h.transform_inverse.transformVector3Into(c.position,i),Math.abs(i.x)-c.shape.radius>h.shape.half_width||Math.abs(i.y)-c.shape.radius>h.shape.half_height||Math.abs(i.z)-c.shape.radius>h.shape.half_depth||(o.x=o.y=o.z=0,r=i.x,r>h.shape.half_width?r=h.shape.half_width:-h.shape.half_width>r&&(r=-h.shape.half_width),o.x=r,r=i.y,r>h.shape.half_height?r=h.shape.half_height:-h.shape.half_height>r&&(r=-h.shape.half_height),o.y=r,r=i.z,r>h.shape.half_depth?r=h.shape.half_depth:-h.shape.half_depth>r&&(r=-h.shape.half_depth),o.z=r,e.subtractVectors(o,i),r=e.lengthSquared(),r>c.shape.radius*c.shape.radius)?void 0:(n=t.ObjectPool.getObject("ContactDetails"),n.object_a=c,n.object_b=h,0===r?t.BoxSphere.spherePenetration(h.shape,i,o,n):(n.contact_normal.subtractVectors(o,i),n.penetration_depth=-n.contact_normal.length(),n.contact_normal.scale(-1/n.penetration_depth),n.contact_point_in_b.copy(o)),n.penetration_depth+=c.shape.radius,h.transform.rotateVector3(n.contact_normal),c.transform_inverse.rotateVector3Into(n.contact_normal,n.contact_point_in_a),n.contact_point_in_a.scale(c.shape.radius),n.contact_point.scaleVector(n.contact_normal,c.shape.radius-n.penetration_depth/2),n.contact_point.add(c.position),n.restitution=(c.restitution+h.restitution)/2,n.friction=(c.friction+h.friction)/2,n)},t.BoxSphere.spherePenetration=function(t,i,e,s){var a,n;0>i.x?(a=t.half_width+i.x,e.x=-t.half_width,e.y=e.z=0,s.penetration_depth=a):(a=t.half_width-i.x,e.x=t.half_width,e.y=e.z=0,s.penetration_depth=a),0>i.y?(n=t.half_height+i.y,a>n&&(a=n,e.y=-t.half_height,e.x=e.z=0,s.penetration_depth=a)):(n=t.half_height-i.y,a>n&&(a=n,e.y=t.half_height,e.x=e.z=0,s.penetration_depth=a)),0>i.z?(n=t.half_depth+i.z,a>n&&(e.z=-t.half_depth,e.x=e.y=0,s.penetration_depth=a)):(n=t.half_depth-i.z,a>n&&(e.z=t.half_depth,e.x=e.y=0,s.penetration_depth=a)),s.contact_point_in_b.copy(o),s.contact_normal.scaleVector(s.contact_point_in_b,-1),s.contact_normal.normalize()},t.GjkEpa={margins:.03,result:null,max_iterations:20,epa_condition:.001,SupportPoint:function(t,i,o){this.witness_a=t,this.witness_b=i,this.point=o},findSupportPoint:function(){var i=new t.Vector3;return function(t,o,e,s){t.findSupportPoint(e,s.witness_a),i.scaleVector(e,-1),o.findSupportPoint(i,s.witness_b),s.point.subtractVectors(s.witness_a,s.witness_b)}}(),testCollision:function(i,o){var e=t.GjkEpa.GJK(i,o);return null!=t.GjkEpa.result?t.GjkEpa.result:null!=e?t.GjkEpa.EPA(e):void 0},GJK:function(){return function(i,o){var e,s=new t.GjkEpa.Simplex(i,o);for(t.GjkEpa.result=null;e=s.addPoint(););return e===!1?(t.GjkEpa.freeSimplex(s),null):s}}(),freeSimplex:function(i){for(var o=0,e=i.points.length;e>o;o++)t.ObjectPool.freeObject("GJK2SupportPoint",i.points[o])},freePolyhedron:function(i){for(var o=t.ObjectPool.pools.GJK2SupportPoint,e=0,s=i.faces.length;s>e;e++)-1===o.indexOf(i.faces[e].a)&&t.ObjectPool.freeObject("GJK2SupportPoint",i.faces[e].a),-1===o.indexOf(i.faces[e].b)&&t.ObjectPool.freeObject("GJK2SupportPoint",i.faces[e].b),-1===o.indexOf(i.faces[e].c)&&t.ObjectPool.freeObject("GJK2SupportPoint",i.faces[e].c)},EPA:function(){var o=new t.Vector3,e={a:new t.Vector3,b:new t.Vector3,c:new t.Vector3};return function(s){for(var a=new t.GjkEpa.Polyhedron(s),n=0;++n;){a.findFaceClosestToOrigin(),a.closest_face_distance<t.EPSILON?i.copy(a.faces[a.closest_face].normal):i.copy(a.closest_point);var r=t.ObjectPool.getObject("GJK2SupportPoint");t.GjkEpa.findSupportPoint(s.object_a,s.object_b,i,r),i.subtractVectors(r.point,a.closest_point);var c=i.lengthSquared();if(n===t.GjkEpa.max_iterations||t.GjkEpa.epa_condition>c&&a.closest_face_distance>t.EPSILON){var h=t.ObjectPool.getObject("ContactDetails");return h.object_a=s.object_a,h.object_b=s.object_b,h.contact_normal.normalizeVector(a.closest_point),0===h.contact_normal.lengthSquared()&&h.contact_normal.subtractVectors(h.object_b.position,h.object_a.position),h.contact_normal.normalize(),t.GeometryMethods.findBarycentricCoordinates(a.closest_point,a.faces[a.closest_face].a.point,a.faces[a.closest_face].b.point,a.faces[a.closest_face].c.point,o),isNaN(o.x)?(t.GjkEpa.freePolyhedron(a),null):(e.a.scaleVector(a.faces[a.closest_face].a.witness_a,o.x),e.b.scaleVector(a.faces[a.closest_face].b.witness_a,o.y),e.c.scaleVector(a.faces[a.closest_face].c.witness_a,o.z),h.contact_point_in_a.addVectors(e.a,e.b),h.contact_point_in_a.add(e.c),e.a.scaleVector(a.faces[a.closest_face].a.witness_b,o.x),e.b.scaleVector(a.faces[a.closest_face].b.witness_b,o.y),e.c.scaleVector(a.faces[a.closest_face].c.witness_b,o.z),h.contact_point_in_b.addVectors(e.a,e.b),h.contact_point_in_b.add(e.c),h.contact_point.addVectors(h.contact_point_in_a,h.contact_point_in_b),h.contact_point.scale(.5),h.object_a.transform_inverse.transformVector3(h.contact_point_in_a),h.object_b.transform_inverse.transformVector3(h.contact_point_in_b),h.penetration_depth=a.closest_point.length()+t.GjkEpa.margins,h.restitution=(s.object_a.restitution+s.object_b.restitution)/2,h.friction=(s.object_a.friction+s.object_b.friction)/2,t.GjkEpa.freePolyhedron(a),h)}a.addVertex(r)}return t.GjkEpa.freePolyhedron(a),null}}(),Face:function(e,s,a,n){this.active=!0,this.a=s,this.b=a,this.c=n,this.normal=new t.Vector3,this.neighbors=[],i.subtractVectors(a.point,s.point),o.subtractVectors(n.point,s.point),this.normal.crossVectors(i,o),this.normal.normalize()}},t.GjkEpa.Polyhedron=function(i){this.closest_face=null,this.closest_face_distance=null,this.closest_point=new t.Vector3,this.faces=[new t.GjkEpa.Face(this,i.points[2],i.points[1],i.points[0]),new t.GjkEpa.Face(this,i.points[3],i.points[1],i.points[2]),new t.GjkEpa.Face(this,i.points[1],i.points[3],i.points[0]),new t.GjkEpa.Face(this,i.points[0],i.points[3],i.points[2])],this.faces[0].neighbors.push(this.faces[1],this.faces[2],this.faces[3]),this.faces[1].neighbors.push(this.faces[2],this.faces[0],this.faces[3]),this.faces[2].neighbors.push(this.faces[1],this.faces[3],this.faces[0]),this.faces[3].neighbors.push(this.faces[2],this.faces[1],this.faces[0])},t.GjkEpa.Polyhedron.prototype={addVertex:function(i){var o,e,s,a,n,r=[],c=[];for(this.faces[this.closest_face].silhouette(i,r),o=0;r.length-5>o;o+=5){if(s=r[o+3],a=r[o+4],0!==o&&n!==s)for(e=o+5;r.length>e;e+=5)if(r[e+3]===n){var h=r.slice(o,o+5);r[o]=r[e],r[o+1]=r[e+1],r[o+2]=r[e+2],r[o+3]=r[e+3],r[o+4]=r[e+4],r[e]=h[0],r[e+1]=h[1],r[e+2]=h[2],r[e+3]=h[3],r[e+4]=h[4],s=r[o+3],a=r[o+4];break}n=a}for(o=0;r.length>o;o+=5){var l=r[o];s=r[o+3],a=r[o+4];var p=new t.GjkEpa.Face(this,a,i,s);p.neighbors[2]=r[o],c.push(p),l.neighbors[l.neighbors.indexOf(r[o+2])]=p}for(o=0;c.length>o;o++)c[o].neighbors[0]=c[o+1===c.length?0:o+1],c[o].neighbors[1]=c[0>o-1?c.length-1:o-1];return Array.prototype.push.apply(this.faces,c),r},findFaceClosestToOrigin:function(){var i=new t.Vector3,o=new t.Vector3;return function(){this.closest_face_distance=1/0;var e,s;for(s=0;this.faces.length>s;s++)this.faces[s].active!==!1&&(t.GeometryMethods.findClosestPointInTriangle(i,this.faces[s].a.point,this.faces[s].b.point,this.faces[s].c.point,o),e=o.lengthSquared(),this.closest_face_distance>e&&(this.closest_face_distance=e,this.closest_face=s,this.closest_point.copy(o)))}}()},t.GjkEpa.Face.prototype={classifyVertex:function(t){var i=this.normal.dot(this.a.point);return this.normal.dot(t.point)-i},silhouette:function(t,i,o){if(this.active!==!1)if(this.classifyVertex(t)>0)this.active=!1,this.neighbors[0].silhouette(t,i,this),this.neighbors[1].silhouette(t,i,this),this.neighbors[2].silhouette(t,i,this);else if(o){var e,s,a=this.neighbors.indexOf(o);0===a?(e=this.a,s=this.b):1===a?(e=this.b,s=this.c):(e=this.c,s=this.a),i.push(this,a,o,s,e)}}},function(){var s=new t.Vector3,a=new t.Vector3,n=new t.Vector3,r=new t.Vector3,c=new t.Vector3,h=new t.Vector3,l={a:new t.Vector3,b:new t.Vector3,c:new t.Vector3};t.GjkEpa.Simplex=function(i,o){this.object_a=i,this.object_b=o,this.points=[],this.iterations=0,this.next_direction=new t.Vector3,this.updateDirection()},t.GjkEpa.Simplex.prototype={addPoint:function(){if(++this.iterations===t.GjkEpa.max_iterations)return!1;var o=t.ObjectPool.getObject("GJK2SupportPoint");if(t.GjkEpa.findSupportPoint(this.object_a,this.object_b,this.next_direction,o),this.points.push(o),0>o.point.dot(this.next_direction)&&this.points.length>1){if(this.points.length>=3){t.GeometryMethods.findClosestPointInTriangle(s,this.points[0].point,this.points[1].point,this.points[2].point,i);var e=i.lengthSquared();if(t.GjkEpa.margins*t.GjkEpa.margins>=e){var a=t.ObjectPool.getObject("ContactDetails");return a.object_a=this.object_a,a.object_b=this.object_b,a.contact_normal.normalizeVector(i),0===a.contact_normal.lengthSquared()&&a.contact_normal.subtractVectors(a.object_b.position,a.object_a.position),a.contact_normal.normalize(),a.contact_normal.scale(-1),a.penetration_depth=t.GjkEpa.margins-Math.sqrt(e),t.GeometryMethods.findBarycentricCoordinates(i,this.points[0].point,this.points[1].point,this.points[2].point,h),isNaN(h.x)?!1:(l.a.scaleVector(this.points[0].witness_a,h.x),l.b.scaleVector(this.points[1].witness_a,h.y),l.c.scaleVector(this.points[2].witness_a,h.z),a.contact_point_in_a.addVectors(l.a,l.b),a.contact_point_in_a.add(l.c),a.contact_point_in_b.scaleVector(a.contact_normal,-a.penetration_depth),a.contact_point_in_b.add(a.contact_point_in_a),a.contact_point.addVectors(a.contact_point_in_a,a.contact_point_in_b),a.contact_point.scale(.5),a.object_a.transform_inverse.transformVector3(a.contact_point_in_a),a.object_b.transform_inverse.transformVector3(a.contact_point_in_b),a.restitution=(this.object_a.restitution+this.object_b.restitution)/2,a.friction=(this.object_a.friction+this.object_b.friction)/2,t.GjkEpa.result=a,null)}}return!1}return this.updateDirection()===!0?null:o},findDirectionFromLine:function(){a.scaleVector(this.points[1].point,-1),n.subtractVectors(this.points[0].point,this.points[1].point),0>n.dot(a)?(this.next_direction.copy(a),t.ObjectPool.freeObject("GJK2SupportPoint",this.points[1]),this.points.length=1):(this.next_direction.crossVectors(n,a),this.next_direction.cross(n),0===this.next_direction.x&&0===this.next_direction.y&&0===this.next_direction.z&&(n.normalize(),this.next_direction.x=1-Math.abs(n.x),this.next_direction.y=1-Math.abs(n.y),this.next_direction.z=1-Math.abs(n.z)))},findDirectionFromTriangle:function(){var s=this.points[2],c=this.points[1],h=this.points[0];a.scaleVector(s.point,-1),n.subtractVectors(c.point,s.point),r.subtractVectors(h.point,s.point),i.crossVectors(n,r),o.crossVectors(n,i),e.crossVectors(i,r),e.dot(a)>=0?r.dot(a)>=0?(this.points.length=0,this.points.push(h,s),t.ObjectPool.freeObject("GJK2SupportPoint",c),this.next_direction.crossVectors(r,a),this.next_direction.cross(r)):n.dot(a)>=0?(this.points.length=0,this.points.push(c,s),t.ObjectPool.freeObject("GJK2SupportPoint",h),this.next_direction.crossVectors(n,a),this.next_direction.cross(n)):(this.points.length=0,this.points.push(s),t.ObjectPool.freeObject("GJK2SupportPoint",c),t.ObjectPool.freeObject("GJK2SupportPoint",h)):o.dot(a)>=0?n.dot(a)>=0?(this.points.length=0,this.points.push(c,s),t.ObjectPool.freeObject("GJK2SupportPoint",h),this.next_direction.crossVectors(n,a),this.next_direction.cross(n)):(this.points.length=0,this.points.push(s),t.ObjectPool.freeObject("GJK2SupportPoint",c),t.ObjectPool.freeObject("GJK2SupportPoint",h)):i.dot(a)>=0?(this.next_direction.copy(i),this.points.length=0,this.points.push(s,c,h)):(this.next_direction.copy(i),this.next_direction.scale(-1))},getFaceNormal:function(t,i,o,e){n.subtractVectors(i.point,t.point),r.subtractVectors(o.point,t.point),e.crossVectors(n,r),e.normalize()},faceNormalDotOrigin:function(t,e,s){return this.getFaceNormal(t,e,s,i),o.addVectors(t.point,e.point),o.add(s.point),o.scale(-3),o.normalize(),i.dot(o)},findDirectionFromTetrahedron:function(){var o,e=this.points[3],s=this.points[2],a=this.points[1],n=this.points[0],r=null,c=t.EPSILON;return o=this.faceNormalDotOrigin(s,a,n),o>c&&(r=1,c=o),o=this.faceNormalDotOrigin(e,a,s),o>c&&(r=2,c=o),o=this.faceNormalDotOrigin(a,e,n),o>c&&(r=3,c=o),o=this.faceNormalDotOrigin(n,e,s),o>c&&(r=4,c=o),null===r?!0:(1===r?(this.points.length=0,this.points.push(s,a,n),this.getFaceNormal(s,a,n,i),this.next_direction.copy(i)):2===r?(this.points.length=0,this.points.push(e,a,s),this.getFaceNormal(e,a,s,i),this.next_direction.copy(i)):3===r?(this.points.length=0,this.points.push(a,e,n),this.getFaceNormal(a,e,n,i),this.next_direction.copy(i)):4===r&&(this.points.length=0,this.points.push(n,e,s),this.getFaceNormal(n,e,s,i),this.next_direction.copy(i)),void 0)},containsOrigin:function(){var t=this.points[3],o=this.points[2],e=this.points[1],s=this.points[0];return n.subtractVectors(s.point,t.point),c.subtractVectors(e.point,t.point),i.crossVectors(n,c),i.dot(t.point)>0?!1:(n.subtractVectors(e.point,t.point),c.subtractVectors(o.point,t.point),i.crossVectors(n,c),i.dot(t.point)>0?!1:(n.subtractVectors(o.point,t.point),c.subtractVectors(s.point,t.point),i.crossVectors(n,c),i.dot(t.point)>0?!1:(n.subtractVectors(s.point,e.point),c.subtractVectors(o.point,e.point),i.crossVectors(n,c),i.dot(s.point)>0?!1:!0)))},updateDirection:function(){if(0===this.points.length)this.next_direction.subtractVectors(this.object_b.position,this.object_a.position);else if(1===this.points.length)this.next_direction.scale(-1);else if(2===this.points.length)this.findDirectionFromLine();else{if(3!==this.points.length)return this.findDirectionFromTetrahedron();this.findDirectionFromTriangle()}}}}(),t.SphereSphere=function(o,e){var s=o.position,a=e.position;i.subtractVectors(a,s);var n=i.length();if(!(n>o.shape.radius+e.shape.radius)){var r=t.ObjectPool.getObject("ContactDetails");return r.object_a=o,r.object_b=e,r.contact_normal.scaleVector(i,1/n),i.scale(-.5),r.contact_point.addVectors(i,s),r.penetration_depth=o.shape.radius+e.shape.radius-n,r.contact_point_in_a.scaleVector(r.contact_normal,r.object_a.shape.radius),r.contact_point_in_a.add(r.object_a.position),r.contact_point_in_b.scaleVector(r.contact_normal,-r.object_b.shape.radius),r.contact_point_in_b.add(r.object_b.position),r.contact_point.addVectors(r.contact_point_in_a,r.contact_point_in_b),r.contact_point.scale(.5),r.object_a.transform_inverse.transformVector3(r.contact_point_in_a),r.object_b.transform_inverse.transformVector3(r.contact_point_in_b),r.restitution=(o.restitution+e.restitution)/2,r.friction=(o.friction+e.friction)/2,r}},t.Constraint=function(){this.active=!0,this.object_a=null,this.object_b=null,this.rows=[],this.factor=1,this.last_impulse=new t.Vector3,this.breaking_threshold=0,this.listeners={}},t.EventEmitter.apply(t.Constraint),t.Constraint.prototype.deactivate=function(){this.active=!1,this.emit("deactivate")},t.Constraint.prototype.update=function(){},t.ConstraintRow=function(){this.jacobian=new Float64Array(12),this.B=new Float64Array(12),this.D=0,this.lower_limit=-1/0,this.upper_limit=1/0,this.bias=0,this.multiplier=0,this.multiplier_cached=0,this.eta=0,this.eta_row=new Float64Array(12)},t.ConstraintRow.prototype.computeB=function(t){var o=0;null!=t.object_a&&1/0!==t.object_a.mass?(o=1/t.object_a.mass,this.B[0]=o*this.jacobian[0],this.B[1]=o*this.jacobian[1],this.B[2]=o*this.jacobian[2],i.x=this.jacobian[3],i.y=this.jacobian[4],i.z=this.jacobian[5],t.object_a.inverseInertiaTensorWorldFrame.transformVector3(i),this.B[3]=i.x,this.B[4]=i.y,this.B[5]=i.z):(this.B[0]=this.B[1]=this.B[2]=0,this.B[3]=this.B[4]=this.B[5]=0),null!=t.object_b&&1/0!==t.object_b.mass?(o=1/t.object_b.mass,this.B[6]=o*this.jacobian[6],this.B[7]=o*this.jacobian[7],this.B[8]=o*this.jacobian[8],i.x=this.jacobian[9],i.y=this.jacobian[10],i.z=this.jacobian[11],t.object_b.inverseInertiaTensorWorldFrame.transformVector3(i),this.B[9]=i.x,this.B[10]=i.y,this.B[11]=i.z):(this.B[6]=this.B[7]=this.B[8]=0,this.B[9]=this.B[10]=this.B[11]=0)},t.ConstraintRow.prototype.computeD=function(){this.D=this.jacobian[0]*this.B[0]+this.jacobian[1]*this.B[1]+this.jacobian[2]*this.B[2]+this.jacobian[3]*this.B[3]+this.jacobian[4]*this.B[4]+this.jacobian[5]*this.B[5]+this.jacobian[6]*this.B[6]+this.jacobian[7]*this.B[7]+this.jacobian[8]*this.B[8]+this.jacobian[9]*this.B[9]+this.jacobian[10]*this.B[10]+this.jacobian[11]*this.B[11]},t.ConstraintRow.prototype.computeEta=function(t,o){var e,s=1/o;null==t.object_a||1/0===t.object_a.mass?this.eta_row[0]=this.eta_row[1]=this.eta_row[2]=this.eta_row[3]=this.eta_row[4]=this.eta_row[5]=0:(e=1/t.object_a.mass,this.eta_row[0]=(t.object_a.linear_velocity.x+e*t.object_a.accumulated_force.x)*s,this.eta_row[1]=(t.object_a.linear_velocity.y+e*t.object_a.accumulated_force.y)*s,this.eta_row[2]=(t.object_a.linear_velocity.z+e*t.object_a.accumulated_force.z)*s,i.copy(t.object_a.accumulated_torque),t.object_a.inverseInertiaTensorWorldFrame.transformVector3(i),this.eta_row[3]=(t.object_a.angular_velocity.x+i.x)*s,this.eta_row[4]=(t.object_a.angular_velocity.y+i.y)*s,this.eta_row[5]=(t.object_a.angular_velocity.z+i.z)*s),null==t.object_b||1/0===t.object_b.mass?this.eta_row[6]=this.eta_row[7]=this.eta_row[8]=this.eta_row[9]=this.eta_row[10]=this.eta_row[11]=0:(e=1/t.object_b.mass,this.eta_row[6]=(t.object_b.linear_velocity.x+e*t.object_b.accumulated_force.x)*s,this.eta_row[7]=(t.object_b.linear_velocity.y+e*t.object_b.accumulated_force.y)*s,this.eta_row[8]=(t.object_b.linear_velocity.z+e*t.object_b.accumulated_force.z)*s,i.copy(t.object_b.accumulated_torque),t.object_b.inverseInertiaTensorWorldFrame.transformVector3(i),this.eta_row[9]=(t.object_b.angular_velocity.x+i.x)*s,this.eta_row[10]=(t.object_b.angular_velocity.y+i.y)*s,this.eta_row[11]=(t.object_b.angular_velocity.z+i.z)*s);var a=this.jacobian[0]*this.eta_row[0]+this.jacobian[1]*this.eta_row[1]+this.jacobian[2]*this.eta_row[2]+this.jacobian[3]*this.eta_row[3]+this.jacobian[4]*this.eta_row[4]+this.jacobian[5]*this.eta_row[5]+this.jacobian[6]*this.eta_row[6]+this.jacobian[7]*this.eta_row[7]+this.jacobian[8]*this.eta_row[8]+this.jacobian[9]*this.eta_row[9]+this.jacobian[10]*this.eta_row[10]+this.jacobian[11]*this.eta_row[11];this.eta=this.bias*s-a},t.ContactConstraint=function(){t.Constraint.call(this),this.contact=null},t.ContactConstraint.prototype=Object.create(t.Constraint.prototype),t.ContactConstraint.prototype.buildFromContact=function(i){this.object_a=i.object_a,this.object_b=i.object_b,this.contact=i;var o=this,e=function(){this.removeListener("destroy",e),o.deactivate()};this.contact.addListener("destroy",e);var s=this.rows[0]||t.ObjectPool.getObject("ConstraintRow");s.lower_limit=0,s.upper_limit=1/0,this.rows[0]=s,this.update()},t.ContactConstraint.prototype.update=function(){var t=this.rows[0];null==this.object_a||1/0===this.object_a.mass?(t.jacobian[0]=t.jacobian[1]=t.jacobian[2]=0,t.jacobian[3]=t.jacobian[4]=t.jacobian[5]=0):(t.jacobian[0]=-this.contact.contact_normal.x,t.jacobian[1]=-this.contact.contact_normal.y,t.jacobian[2]=-this.contact.contact_normal.z,i.subtractVectors(this.contact.contact_point,this.contact.object_a.position),i.cross(this.contact.contact_normal),t.jacobian[3]=-i.x,t.jacobian[4]=-i.y,t.jacobian[5]=-i.z),null==this.object_b||1/0===this.object_b.mass?(t.jacobian[6]=t.jacobian[7]=t.jacobian[8]=0,t.jacobian[9]=t.jacobian[10]=t.jacobian[11]=0):(t.jacobian[6]=this.contact.contact_normal.x,t.jacobian[7]=this.contact.contact_normal.y,t.jacobian[8]=this.contact.contact_normal.z,i.subtractVectors(this.contact.contact_point,this.contact.object_b.position),i.cross(this.contact.contact_normal),t.jacobian[9]=i.x,t.jacobian[10]=i.y,t.jacobian[11]=i.z),t.bias=0;var o=0;1/0!==this.object_a.mass&&(this.object_a.getVelocityInLocalPoint(this.contact.contact_point_in_a,i),o+=i.dot(this.contact.contact_normal)),1/0!==this.object_b.mass&&(this.object_b.getVelocityInLocalPoint(this.contact.contact_point_in_b,i),o-=i.dot(this.contact.contact_normal)),t.bias+=o*this.contact.restitution
},t.FrictionConstraint=function(){t.Constraint.call(this),this.contact=null},t.FrictionConstraint.prototype=Object.create(t.Constraint.prototype),t.FrictionConstraint.prototype.buildFromContact=function(i){this.rows[0]=this.rows[0]||t.ObjectPool.getObject("ConstraintRow"),this.rows[1]=this.rows[1]||t.ObjectPool.getObject("ConstraintRow"),this.object_a=i.object_a,this.object_b=i.object_b,this.contact=i;var o=this,e=function(){this.removeListener("destroy",e),o.deactivate()};this.contact.addListener("destroy",e),this.update()},t.FrictionConstraint.prototype.update=function(){var s=this.rows[0],a=this.rows[1],n=new t.Vector3,r=new t.Vector3;n.subtractVectors(this.contact.contact_point,this.object_a.position),r.subtractVectors(this.contact.contact_point,this.object_b.position);var c,h,l=new t.Vector3,p=new t.Vector3;Math.abs(this.contact.contact_normal.z)>.7071067811865475?(c=-this.contact.contact_normal.y*this.contact.contact_normal.y+this.contact.contact_normal.z*this.contact.contact_normal.z,h=1/Math.sqrt(c),l.x=0,l.y=-this.contact.contact_normal.z*h,l.z=this.contact.contact_normal.y*h,p.x=c*h,p.y=-this.contact.contact_normal.x*l.z,p.z=this.contact.contact_normal.x*l.y):(c=this.contact.contact_normal.x*this.contact.contact_normal.x+this.contact.contact_normal.y*this.contact.contact_normal.y,h=1/Math.sqrt(c),l.x=-this.contact.contact_normal.y*h,l.y=this.contact.contact_normal.x*h,l.z=0,p.x=-this.contact.contact_normal.z*l.y,p.y=this.contact.contact_normal.z*l.x,p.z=c*h),null==this.object_a||1/0===this.object_a.mass?(s.jacobian[0]=s.jacobian[1]=s.jacobian[2]=0,s.jacobian[3]=s.jacobian[4]=s.jacobian[5]=0,a.jacobian[0]=a.jacobian[1]=a.jacobian[2]=0,a.jacobian[3]=a.jacobian[4]=a.jacobian[5]=0):(s.jacobian[0]=-l.x,s.jacobian[1]=-l.y,s.jacobian[2]=-l.z,i.crossVectors(n,l),s.jacobian[3]=-i.x,s.jacobian[4]=-i.y,s.jacobian[5]=-i.z,a.jacobian[0]=-p.x,a.jacobian[1]=-p.y,a.jacobian[2]=-p.z,i.crossVectors(n,p),a.jacobian[3]=-i.x,a.jacobian[4]=-i.y,a.jacobian[5]=-i.z),null==this.object_b||1/0===this.object_b.mass?(s.jacobian[6]=s.jacobian[7]=s.jacobian[8]=0,s.jacobian[9]=s.jacobian[10]=s.jacobian[11]=0,a.jacobian[6]=a.jacobian[7]=a.jacobian[8]=0,a.jacobian[9]=a.jacobian[10]=a.jacobian[11]=0):(s.jacobian[6]=l.x,s.jacobian[7]=l.y,s.jacobian[8]=l.z,i.crossVectors(r,l),s.jacobian[9]=i.x,s.jacobian[10]=i.y,s.jacobian[11]=i.z,a.jacobian[6]=p.x,a.jacobian[7]=p.y,a.jacobian[8]=p.z,i.crossVectors(r,p),a.jacobian[9]=i.x,a.jacobian[10]=i.y,a.jacobian[11]=i.z),this.object_a.getVelocityInLocalPoint(this.contact.contact_point_in_a,i),1/0!==this.object_a.mass?(i.scaleVector(this.object_a.accumulated_force,1/this.object_a.mass),i.add(this.object_a.linear_velocity),this.object_a.inverseInertiaTensorWorldFrame.transformVector3Into(this.object_a.accumulated_torque,e),e.add(this.object_a.angular_velocity),e.cross(this.contact.contact_point_in_a),i.add(e),i.scale(this.object_a.mass)):i.set(0,0,0),1/0!==this.object_b.mass?(o.scaleVector(this.object_b.accumulated_force,1/this.object_b.mass),o.add(this.object_b.linear_velocity),this.object_b.inverseInertiaTensorWorldFrame.transformVector3Into(this.object_b.accumulated_torque,e),e.add(this.object_b.angular_velocity),e.cross(this.contact.contact_point_in_b),o.add(e),o.scale(this.object_b.mass)):o.set(0,0,0),i.subtract(o);var _=i.dot(this.contact.contact_normal),b=10*this.contact.friction*_;0>b&&(b=0),s.lower_limit=a.lower_limit=-b,s.upper_limit=a.upper_limit=b,s.bias=a.bias=0,this.rows[0]=s,this.rows[1]=a},t.PointConstraint=function(i,o,e,s){t.Constraint.call(this),this.object_a=i,this.point_a=o,this.object_b=e||null,null!=this.object_b?this.point_b=s:(this.point_b=new t.Vector3,this.object_a.updateDerived(),this.object_a.transform.transformVector3Into(this.point_a,this.point_b)),this.erp=.1;for(var a=0;3>a;a++)this.rows[a]=t.ObjectPool.getObject("ConstraintRow"),this.rows[a].lower_limit=-1/0,this.rows[a].upper_limit=1/0,this.rows[a].bias=0,this.rows[a].jacobian[6]=this.rows[a].jacobian[7]=this.rows[a].jacobian[8]=this.rows[a].jacobian[9]=this.rows[a].jacobian[10]=this.rows[a].jacobian[11]=0},t.PointConstraint.prototype=Object.create(t.Constraint.prototype),t.PointConstraint.prototype.update=function(){var s=new t.Vector3,a=new t.Vector3;return function(t){this.object_a.transform.transformVector3Into(this.point_a,i),s.subtractVectors(i,this.object_a.position),this.rows[0].jacobian[0]=-1,this.rows[0].jacobian[1]=0,this.rows[0].jacobian[2]=0,this.rows[0].jacobian[3]=0,this.rows[0].jacobian[4]=-s.z,this.rows[0].jacobian[5]=s.y,this.rows[1].jacobian[0]=0,this.rows[1].jacobian[1]=-1,this.rows[1].jacobian[2]=0,this.rows[1].jacobian[3]=s.z,this.rows[1].jacobian[4]=0,this.rows[1].jacobian[5]=-s.x,this.rows[2].jacobian[0]=0,this.rows[2].jacobian[1]=0,this.rows[2].jacobian[2]=-1,this.rows[2].jacobian[3]=-s.y,this.rows[2].jacobian[4]=s.x,this.rows[2].jacobian[5]=0,null!=this.object_b?(this.object_b.transform.transformVector3Into(this.point_b,o),a.subtractVectors(o,this.object_b.position),this.rows[0].jacobian[6]=1,this.rows[0].jacobian[7]=0,this.rows[0].jacobian[8]=0,this.rows[0].jacobian[9]=0,this.rows[0].jacobian[10]=a.z,this.rows[0].jacobian[11]=-a.y,this.rows[1].jacobian[6]=0,this.rows[1].jacobian[7]=1,this.rows[1].jacobian[8]=0,this.rows[1].jacobian[9]=-a.z,this.rows[1].jacobian[10]=0,this.rows[1].jacobian[11]=a.x,this.rows[2].jacobian[6]=0,this.rows[2].jacobian[7]=0,this.rows[2].jacobian[8]=1,this.rows[2].jacobian[9]=a.y,this.rows[2].jacobian[10]=-a.z,this.rows[2].jacobian[11]=0):o.copy(this.point_b),e.subtractVectors(i,o),e.scale(this.erp/t),this.rows[0].bias=e.x,this.rows[1].bias=e.y,this.rows[2].bias=e.z}}(),t.SliderConstraint=function(i,o,e){t.Constraint.call(this),this.object_a=i,this.axis=o,this.object_b=e,this.position_error=new t.Vector3,this.position_error.subtractVectors(this.object_b.position,this.object_a.position),s.invertQuaternion(this.object_a.rotation),s.transformVector3(this.position_error),this.rotation_difference=new t.Quaternion,null!=this.object_b&&(s.invertQuaternion(this.object_b.rotation),this.rotation_difference.multiplyQuaternions(s,this.object_a.rotation)),this.erp=.1;for(var a=0;5>a;a++)this.rows[a]=t.ObjectPool.getObject("ConstraintRow"),this.rows[a].lower_limit=-1/0,this.rows[a].upper_limit=1/0,this.rows[a].bias=0,this.rows[a].jacobian[0]=this.rows[a].jacobian[1]=this.rows[a].jacobian[2]=this.rows[a].jacobian[3]=this.rows[a].jacobian[4]=this.rows[a].jacobian[5]=this.rows[a].jacobian[6]=this.rows[a].jacobian[7]=this.rows[a].jacobian[8]=this.rows[a].jacobian[9]=this.rows[a].jacobian[10]=this.rows[a].jacobian[11]=0},t.SliderConstraint.prototype=Object.create(t.Constraint.prototype),t.SliderConstraint.prototype.update=function(){var i=new t.Vector3,o=new t.Vector3,e=new t.Vector3;return function(t){this.object_a.rotation.transformVector3Into(this.axis,i),o.x=i.y,o.y=-i.x,o.z=0,o.normalize(),e.crossVectors(i,o),this._updateLinearConstraints(t,o,e),this._updateAngularConstraints(t,o,e)}}(),t.SliderConstraint.prototype._updateLinearConstraints=function(e,s,a){var n=new t.Vector3;n.subtractVectors(this.object_b.position,this.object_a.position);var r=new t.Vector3;r.crossVectors(n,s),this.rows[0].jacobian[0]=-s.x,this.rows[0].jacobian[1]=-s.y,this.rows[0].jacobian[2]=-s.z,this.rows[0].jacobian[6]=s.x,this.rows[0].jacobian[7]=s.y,this.rows[0].jacobian[8]=s.z,this.rows[0].jacobian[9]=0,this.rows[0].jacobian[10]=0,this.rows[0].jacobian[11]=0,r.crossVectors(n,a),this.rows[1].jacobian[0]=-a.x,this.rows[1].jacobian[1]=-a.y,this.rows[1].jacobian[2]=-a.z,this.rows[1].jacobian[6]=a.x,this.rows[1].jacobian[7]=a.y,this.rows[1].jacobian[8]=a.z,this.rows[1].jacobian[9]=0,this.rows[1].jacobian[10]=0,this.rows[1].jacobian[11]=0,this.object_a.rotation.transformVector3Into(this.position_error,i),o.subtractVectors(n,i),o.scale(this.erp/e),this.rows[0].bias=-s.dot(o),this.rows[1].bias=-a.dot(o)},t.SliderConstraint.prototype._updateAngularConstraints=function(i){this.rows[2].jacobian[3]=this.rows[3].jacobian[4]=this.rows[4].jacobian[5]=-1,this.rows[2].jacobian[9]=this.rows[3].jacobian[10]=this.rows[4].jacobian[11]=1,s.invertQuaternion(this.object_b.rotation),s.multiply(this.object_a.rotation),a.invertQuaternion(this.rotation_difference),a.multiply(s);var o=new t.Vector3;o.x=a.x,o.y=a.y,o.z=a.z,o.scale(this.erp/i)},t.WeldConstraint=function(i,o,e,a){t.Constraint.call(this),this.object_a=i,this.point_a=o,this.object_b=e||null,this.point_b=a||null,this.rotation_difference=new t.Quaternion,null!=this.object_b&&(s.invertQuaternion(this.object_b.rotation),this.rotation_difference.multiplyQuaternions(s,this.object_a.rotation)),this.erp=.1;for(var n=0;3>n;n++)this.rows[n]=t.ObjectPool.getObject("ConstraintRow"),this.rows[n].lower_limit=-1/0,this.rows[n].upper_limit=1/0,this.rows[n].bias=0,null==this.object_b&&(this.rows[n].jacobian[0]=this.rows[n].jacobian[1]=this.rows[n].jacobian[2]=this.rows[n].jacobian[4]=this.rows[n].jacobian[5]=this.rows[n].jacobian[6]=this.rows[n].jacobian[7]=this.rows[n].jacobian[8]=this.rows[n].jacobian[9]=this.rows[n].jacobian[10]=this.rows[n].jacobian[11]=this.rows[n].jacobian[12]=0,this.rows[n].jacobian[n]=1);for(n=3;6>n;n++)this.rows[n]=t.ObjectPool.getObject("ConstraintRow"),this.rows[n].lower_limit=-1/0,this.rows[n].upper_limit=1/0,this.rows[n].bias=0,null==this.object_b?(this.rows[n].jacobian[0]=this.rows[n].jacobian[1]=this.rows[n].jacobian[2]=this.rows[n].jacobian[4]=this.rows[n].jacobian[5]=this.rows[n].jacobian[6]=this.rows[n].jacobian[7]=this.rows[n].jacobian[8]=this.rows[n].jacobian[9]=this.rows[n].jacobian[10]=this.rows[n].jacobian[11]=this.rows[n].jacobian[12]=0,this.rows[n].jacobian[n]=1):(this.rows[n].jacobian[0]=this.rows[n].jacobian[1]=this.rows[n].jacobian[2]=0,this.rows[n].jacobian[3]=this.rows[n].jacobian[4]=this.rows[n].jacobian[5]=0,this.rows[n].jacobian[n]=-1,this.rows[n].jacobian[6]=this.rows[n].jacobian[7]=this.rows[n].jacobian[8]=0,this.rows[n].jacobian[9]=this.rows[n].jacobian[10]=this.rows[n].jacobian[11]=0,this.rows[n].jacobian[n+6]=1)},t.WeldConstraint.prototype=Object.create(t.Constraint.prototype),t.WeldConstraint.prototype.update=function(){var e=new t.Vector3,n=new t.Vector3;return function(r){if(null!=this.object_b){this.object_a.transform.transformVector3Into(this.point_a,i),e.subtractVectors(i,this.object_a.position),this.rows[0].jacobian[0]=-1,this.rows[0].jacobian[1]=0,this.rows[0].jacobian[2]=0,this.rows[0].jacobian[3]=0,this.rows[0].jacobian[4]=-e.z,this.rows[0].jacobian[5]=e.y,this.rows[1].jacobian[0]=0,this.rows[1].jacobian[1]=-1,this.rows[1].jacobian[2]=0,this.rows[1].jacobian[3]=e.z,this.rows[1].jacobian[4]=0,this.rows[1].jacobian[5]=-e.x,this.rows[2].jacobian[0]=0,this.rows[2].jacobian[1]=0,this.rows[2].jacobian[2]=-1,this.rows[2].jacobian[3]=-e.y,this.rows[2].jacobian[4]=e.x,this.rows[2].jacobian[5]=0,null!=this.object_b?(this.object_b.transform.transformVector3Into(this.point_b,o),n.subtractVectors(o,this.object_b.position),this.rows[0].jacobian[6]=1,this.rows[0].jacobian[7]=0,this.rows[0].jacobian[8]=0,this.rows[0].jacobian[9]=0,this.rows[0].jacobian[10]=n.z,this.rows[0].jacobian[11]=-n.y,this.rows[1].jacobian[6]=0,this.rows[1].jacobian[7]=1,this.rows[1].jacobian[8]=0,this.rows[1].jacobian[9]=-n.z,this.rows[1].jacobian[10]=0,this.rows[1].jacobian[11]=n.x,this.rows[2].jacobian[6]=0,this.rows[2].jacobian[7]=0,this.rows[2].jacobian[8]=1,this.rows[2].jacobian[9]=n.y,this.rows[2].jacobian[10]=-n.x,this.rows[2].jacobian[11]=0):o.copy(this.point_b);var c=new t.Vector3;c.subtractVectors(i,o),c.scale(this.erp/r),this.rows[0].bias=c.x,this.rows[1].bias=c.y,this.rows[2].bias=c.z,s.invertQuaternion(this.object_b.rotation),s.multiply(this.object_a.rotation),a.invertQuaternion(this.rotation_difference),a.multiply(s),c.x=a.x,c.y=a.y,c.z=a.z,c.scale(this.erp/r),this.rows[3].bias=c.x,this.rows[4].bias=c.y,this.rows[5].bias=c.z}}}(),t.ContactDetails=function(){this.object_a=null,this.object_b=null,this.contact_point=new t.Vector3,this.contact_point_in_a=new t.Vector3,this.contact_point_in_b=new t.Vector3,this.contact_normal=new t.Vector3,this.penetration_depth=0,this.restitution=0,this.friction=0,this.listeners={}},t.EventEmitter.apply(t.ContactDetails),t.ContactDetails.prototype.destroy=function(){this.emit("destroy"),t.ObjectPool.freeObject("ContactDetails",this)},t.ContactManifold=function(){this.object_a=null,this.object_b=null,this.points=[],this.next_manifold=null},t.ContactManifold.prototype.findWeakestContact=function(t){var e,s,a=-1,n=t.penetration_depth;for(e=0;4>e;e++)s=this.points[e],s.penetration_depth>n&&(n=s.penetration_depth,a=e);var r=0,c=0,h=0,l=0;0!==a&&(i.subtractVectors(t.contact_point_in_a,this.points[1].contact_point_in_a),o.subtractVectors(this.points[3].contact_point_in_a,this.points[2].contact_point_in_a),i.cross(o),r=i.lengthSquared()),1!==a&&(i.subtractVectors(t.contact_point_in_a,this.points[0].contact_point_in_a),o.subtractVectors(this.points[3].contact_point_in_a,this.points[2].contact_point_in_a),i.cross(o),c=i.lengthSquared()),2!==a&&(i.subtractVectors(t.contact_point_in_a,this.points[0].contact_point_in_a),o.subtractVectors(this.points[3].contact_point_in_a,this.points[1].contact_point_in_a),i.cross(o),h=i.lengthSquared()),3!==a&&(i.subtractVectors(t.contact_point_in_a,this.points[0].contact_point_in_a),o.subtractVectors(this.points[2].contact_point_in_a,this.points[1].contact_point_in_a),i.cross(o),l=i.lengthSquared());var p=0,_=r;return c>_&&(p=1,_=c),h>_&&(p=2,_=h),l>_&&(p=3),p},t.ContactManifold.prototype.addContact=function(i){var o;for(o=0;this.points.length>o;o++)if(.02>=this.points[o].contact_point.distanceTo(i.contact_point))return i.destroy(),void 0;var e=!1;if(null!=i&&(e=i.object_a.emit("newContact",i.object_b,i),e!==!1&&(e=i.object_b.emit("newContact",i.object_a,i)),e===!1))return i.emit("destroy"),t.ObjectPool.freeObject("ContactDetails",i),void 0;if(4>this.points.length)this.points.push(i);else{var s=this.findWeakestContact(i);this.points[s].destroy(),this.points[s]=i}},t.ContactManifold.prototype.update=function(){var o,e,s,a=new t.Vector3,n=new t.Vector3,r=new t.Vector3;for(o=0;this.points.length>o;o++)if(s=this.points[o],s.object_a.transform.transformVector3Into(s.contact_point_in_a,a),s.object_b.transform.transformVector3Into(s.contact_point_in_b,n),s.contact_point.addVectors(a,n),s.contact_point.scale(.5),r.subtractVectors(a,n),s.penetration_depth=r.dot(s.contact_normal),-.02>s.penetration_depth){for(s.destroy(),e=o;this.points.length>e;e++)this.points[e]=this.points[e+1];this.points.length=this.points.length-1}else{i.scaleVector(s.contact_normal,s.penetration_depth),i.subtractVectors(a,i),i.subtractVectors(n,i);var c=i.lengthSquared();if(c>.2*.2){for(s.destroy(),e=o;this.points.length>e;e++)this.points[e]=this.points[e+1];this.points.length=this.points.length-1}}},t.ContactManifoldList=function(){this.first=null},t.ContactManifoldList.prototype.insert=function(t){t.next_manifold=this.first,this.first=t},t.ContactManifoldList.prototype.getManifoldForObjects=function(i,o){var e=null;if(null!==this.first)for(var s=this.first;null!==s;){if(s.object_a===i&&s.object_b===o||s.object_a===o&&s.object_b===i){e=s;break}s=s.next_manifold}return null===e&&(e=t.ObjectPool.getObject("ContactManifold"),e.object_a=i,e.object_b=o,this.insert(e)),e},t.ForceGenerator=function(i){this.force=i||new t.Vector3,this.enabled=!0,this.affected=[]},t.ForceGenerator.prototype.applyForce=function(){if(this.enabled){var t,i;for(t=0,i=this.affected.length;i>t;t++)this.affected[t].applyForce(this.force)}},t.ForceGenerator.prototype.enable=function(){this.enabled=!0},t.ForceGenerator.prototype.disable=function(){this.enabled=!1},t.ForceGenerator.prototype.affect=function(t){var i,o;for(i=0,o=this.affected.length;o>i;i++)if(this.affected[i]===t)return;this.affected.push(t)},t.ForceGenerator.prototype.unaffect=function(t){var i,o;for(i=0,o=this.affected.length;o>i;i++)if(this.affected[i]===t)return this.affected.splice(i,1),void 0},t.DragForce=function(t,i){this.drag_coefficient=t||0,this.squared_drag_coefficient=i||0,this.enabled=!0,this.affected=[]},t.DragForce.prototype.enable=t.ForceGenerator.prototype.enable,t.DragForce.prototype.disable=t.ForceGenerator.prototype.disable,t.DragForce.prototype.affect=t.ForceGenerator.prototype.affect,t.DragForce.prototype.unaffect=t.ForceGenerator.prototype.unaffect,t.DragForce.prototype.applyForce=function(){if(this.enabled){var t,o,e,s,a=i;for(t=0,o=this.affected.length;o>t;t++)e=this.affected[t],a.copy(e.linear_velocity),s=a.length(),s=this.drag_coefficient*s+this.squared_drag_coefficient*s*s,a.normalize(),a.scale(-s),e.applyForce(a)}},t.IterativeSolver=function(){this.contact_constraints=[],this.friction_constraints=[],this.all_constraints=[],this.constraints=[],this.max_iterations=10,this.penetrations_max_iterations=5,this.relaxation=.1,this.sor_weight=.85,this.warmstarting_factor=.95;var t=this;this.onContactDeactivate=function(){this.removeListener("deactivate",t.onContactDeactivate);var i=t.contact_constraints.indexOf(this);t.contact_constraints.splice(i,1)},this.onFrictionDeactivate=function(){this.removeListener("deactivate",t.onFrictionDeactivate);var i=t.friction_constraints.indexOf(this);t.friction_constraints.splice(i,1)}},t.IterativeSolver.prototype.addConstraint=function(t){-1===this.constraints.indexOf(t)&&this.constraints.push(t)},t.IterativeSolver.prototype.removeConstraint=function(t){var i=this.constraints.indexOf(t);-1!==i&&this.constraints.splice(i,1)},t.IterativeSolver.prototype.processContactManifolds=function(i){var o,e,s,a,n,r;for(s=i.first;s;){for(a=s.points.length,o=0;a>o;o++){n=s.points[o];var c=null;for(e=0;this.contact_constraints.length>e;e++)if(this.contact_constraints[e].contact===n){c=this.contact_constraints[e];break}c||(r=t.ObjectPool.getObject("ContactConstraint"),r.buildFromContact(n),this.contact_constraints.push(r),r.addListener("deactivate",this.onContactDeactivate),r=t.ObjectPool.getObject("FrictionConstraint"),r.buildFromContact(n),this.friction_constraints.push(r),r.addListener("deactivate",this.onFrictionDeactivate))}s=s.next_manifold}this.all_constraints.length=0,Array.prototype.push.apply(this.all_constraints,this.friction_constraints),Array.prototype.push.apply(this.all_constraints,this.constraints),Array.prototype.push.apply(this.all_constraints,this.contact_constraints)},t.IterativeSolver.prototype.prepareConstraints=function(t){var i,o,e,s,a,n=this.all_constraints.length;for(s=0;n>s;s++)if(o=this.all_constraints[s],o.active!==!1)for(i=o.rows.length,o.update(t),a=0;i>a;a++)e=o.rows[a],e.multiplier=0,e.computeB(o),e.computeD(),e.computeEta(o,t)},t.IterativeSolver.prototype.resolveContacts=function(){var o,e,a,n,r,c,h,l=0;for(o=0;this.penetrations_max_iterations>o;o++){for(l=0,r=0;this.contact_constraints.length>r;r++){e=this.contact_constraints[r],n=e.rows[0],a=0,null!=e.object_a&&1/0!==e.object_a.mass&&(a+=n.jacobian[0]*e.object_a.push_velocity.x+n.jacobian[1]*e.object_a.push_velocity.y+n.jacobian[2]*e.object_a.push_velocity.z+n.jacobian[3]*e.object_a.turn_velocity.x+n.jacobian[4]*e.object_a.turn_velocity.y+n.jacobian[5]*e.object_a.turn_velocity.z),null!=e.object_b&&1/0!==e.object_b.mass&&(a+=n.jacobian[6]*e.object_b.push_velocity.x+n.jacobian[7]*e.object_b.push_velocity.y+n.jacobian[8]*e.object_b.push_velocity.z+n.jacobian[9]*e.object_b.turn_velocity.x+n.jacobian[10]*e.object_b.turn_velocity.y+n.jacobian[11]*e.object_b.turn_velocity.z),c=(e.contact.penetration_depth-a)/n.D;var p=n.multiplier;n.multiplier=Math.max(n.lower_limit,Math.min(p+c,n.upper_limit)),c=n.multiplier-p,l=Math.max(l,c),e.object_a&&1/0!==e.object_a.mass&&(e.object_a.push_velocity.x+=c*n.B[0],e.object_a.push_velocity.y+=c*n.B[1],e.object_a.push_velocity.z+=c*n.B[2],e.object_a.turn_velocity.x+=c*n.B[3],e.object_a.turn_velocity.y+=c*n.B[4],e.object_a.turn_velocity.z+=c*n.B[5]),e.object_b&&1/0!==e.object_b.mass&&(e.object_b.push_velocity.x+=c*n.B[6],e.object_b.push_velocity.y+=c*n.B[7],e.object_b.push_velocity.z+=c*n.B[8],e.object_b.turn_velocity.x+=c*n.B[9],e.object_b.turn_velocity.y+=c*n.B[10],e.object_b.turn_velocity.z+=c*n.B[11])}if(l>=-t.EPSILON&&t.EPSILON>=l)break}for(r=0;this.contact_constraints.length>r;r++)e=this.contact_constraints[r],n=e.rows[0],null!=e.object_a&&1/0!==e.object_a.mass&&(h=1/e.object_a.mass,e.object_a.position.x+=h*n.jacobian[0]*n.multiplier*this.relaxation,e.object_a.position.y+=h*n.jacobian[1]*n.multiplier*this.relaxation,e.object_a.position.z+=h*n.jacobian[2]*n.multiplier*this.relaxation,i.x=n.jacobian[3]*n.multiplier*this.relaxation,i.y=n.jacobian[4]*n.multiplier*this.relaxation,i.z=n.jacobian[5]*n.multiplier*this.relaxation,e.object_a.inverseInertiaTensorWorldFrame.transformVector3(i),s.x=i.x,s.y=i.y,s.z=i.z,s.w=0,s.multiply(e.object_a.rotation),e.object_a.rotation.x+=.5*s.x,e.object_a.rotation.y+=.5*s.y,e.object_a.rotation.z+=.5*s.z,e.object_a.rotation.w+=.5*s.w,e.object_a.rotation.normalize()),null!=e.object_b&&1/0!==e.object_b.mass&&(h=1/e.object_b.mass,e.object_b.position.x+=h*n.jacobian[6]*n.multiplier*this.relaxation,e.object_b.position.y+=h*n.jacobian[7]*n.multiplier*this.relaxation,e.object_b.position.z+=h*n.jacobian[8]*n.multiplier*this.relaxation,i.x=n.jacobian[9]*n.multiplier*this.relaxation,i.y=n.jacobian[10]*n.multiplier*this.relaxation,i.z=n.jacobian[11]*n.multiplier*this.relaxation,e.object_b.inverseInertiaTensorWorldFrame.transformVector3(i),s.x=i.x,s.y=i.y,s.z=i.z,s.w=0,s.multiply(e.object_b.rotation),e.object_b.rotation.x+=.5*s.x,e.object_b.rotation.y+=.5*s.y,e.object_b.rotation.z+=.5*s.z,e.object_b.rotation.w+=.5*s.w,e.object_b.rotation.normalize()),n.multiplier=0},t.IterativeSolver.prototype.solveConstraints=function(){var t,i,o,e,s,a,n,r,c,h=this.all_constraints.length,l=0;for(s=0;h>s;s++)if(t=this.all_constraints[s],t.active!==!1)for(a=0;t.rows.length>a;a++)o=t.rows[a],e=o.multiplier_cached*this.warmstarting_factor,o.multiplier=e,t.object_a&&1/0!==t.object_a.mass&&(t.object_a.solver_impulse[0]+=e*o.B[0],t.object_a.solver_impulse[1]+=e*o.B[1],t.object_a.solver_impulse[2]+=e*o.B[2],t.object_a.solver_impulse[3]+=e*o.B[3],t.object_a.solver_impulse[4]+=e*o.B[4],t.object_a.solver_impulse[5]+=e*o.B[5]),t.object_b&&1/0!==t.object_b.mass&&(t.object_b.solver_impulse[0]+=e*o.B[6],t.object_b.solver_impulse[1]+=e*o.B[7],t.object_b.solver_impulse[2]+=e*o.B[8],t.object_b.solver_impulse[3]+=e*o.B[9],t.object_b.solver_impulse[4]+=e*o.B[10],t.object_b.solver_impulse[5]+=e*o.B[11]);for(n=0;this.max_iterations>n;n++){for(l=0,s=0;h>s;s++)if(t=this.all_constraints[s],t.active!==!1)for(i=t.rows.length,a=0;i>a;a++){o=t.rows[a],c=0,null!=t.object_a&&1/0!==t.object_a.mass&&(c+=o.jacobian[0]*t.object_a.solver_impulse[0]+o.jacobian[1]*t.object_a.solver_impulse[1]+o.jacobian[2]*t.object_a.solver_impulse[2]+o.jacobian[3]*t.object_a.solver_impulse[3]+o.jacobian[4]*t.object_a.solver_impulse[4]+o.jacobian[5]*t.object_a.solver_impulse[5]),null!=t.object_b&&1/0!==t.object_b.mass&&(c+=o.jacobian[6]*t.object_b.solver_impulse[0]+o.jacobian[7]*t.object_b.solver_impulse[1]+o.jacobian[8]*t.object_b.solver_impulse[2]+o.jacobian[9]*t.object_b.solver_impulse[3]+o.jacobian[10]*t.object_b.solver_impulse[4]+o.jacobian[11]*t.object_b.solver_impulse[5]),r=(o.eta-c)/o.D*t.factor;var p=o.multiplier,_=p+r;_=this.sor_weight*_+(1-this.sor_weight)*p,o.multiplier=Math.max(o.lower_limit,Math.min(_,o.upper_limit)),r=o.multiplier-p;var b=(t.object_a&&1/0!==t.object_a.mass?t.object_a.mass:0)+(t.object_b&&1/0!==t.object_b.mass?t.object_b.mass:0);l=Math.max(l,Math.abs(r)/b),t.object_a&&1/0!==t.object_a.mass&&(t.object_a.solver_impulse[0]+=r*o.B[0],t.object_a.solver_impulse[1]+=r*o.B[1],t.object_a.solver_impulse[2]+=r*o.B[2],t.object_a.solver_impulse[3]+=r*o.B[3],t.object_a.solver_impulse[4]+=r*o.B[4],t.object_a.solver_impulse[5]+=r*o.B[5]),t.object_b&&1/0!==t.object_b.mass&&(t.object_b.solver_impulse[0]+=r*o.B[6],t.object_b.solver_impulse[1]+=r*o.B[7],t.object_b.solver_impulse[2]+=r*o.B[8],t.object_b.solver_impulse[3]+=r*o.B[9],t.object_b.solver_impulse[4]+=r*o.B[10],t.object_b.solver_impulse[5]+=r*o.B[11])}if(.1>=l)break}},t.IterativeSolver.prototype.applyConstraints=function(t){var e,s,a,n,r,c,h=this.all_constraints.length;for(n=0;h>n;n++)if(e=this.all_constraints[n],e.active!==!1){for(s=e.rows.length,e.last_impulse.x=e.last_impulse.y=e.last_impulse.z=0,r=0;s>r;r++)a=e.rows[r],a.multiplier_cached=a.multiplier,null!=e.object_a&&1/0!==e.object_a.mass&&(c=1/e.object_a.mass,o.x=c*t*a.jacobian[0]*a.multiplier,o.y=c*t*a.jacobian[1]*a.multiplier,o.z=c*t*a.jacobian[2]*a.multiplier,e.object_a.linear_velocity.add(o),e.last_impulse.add(o),i.x=t*a.jacobian[3]*a.multiplier,i.y=t*a.jacobian[4]*a.multiplier,i.z=t*a.jacobian[5]*a.multiplier,e.object_a.inverseInertiaTensorWorldFrame.transformVector3(i),e.object_a.angular_velocity.add(i),e.last_impulse.add(i)),null!=e.object_b&&1/0!==e.object_b.mass&&(c=1/e.object_b.mass,o.x=c*t*a.jacobian[6]*a.multiplier,o.y=c*t*a.jacobian[7]*a.multiplier,o.z=c*t*a.jacobian[8]*a.multiplier,e.object_b.linear_velocity.add(o),e.last_impulse.add(o),i.x=t*a.jacobian[9]*a.multiplier,i.y=t*a.jacobian[10]*a.multiplier,i.z=t*a.jacobian[11]*a.multiplier,e.object_b.inverseInertiaTensorWorldFrame.transformVector3(i),e.object_b.angular_velocity.add(i),e.last_impulse.add(i));e.breaking_threshold>0&&e.last_impulse.lengthSquared()>=e.breaking_threshold*e.breaking_threshold&&(e.active=!1)}},t.NarrowPhase=function(){this.contact_manifolds=new t.ContactManifoldList},t.NarrowPhase.prototype.updateContactManifolds=function(){for(var i=this.contact_manifolds.first,o=null;null!==i;)i.update(),0===i.points.length?(t.ObjectPool.freeObject("ContactManifold",i),null==o?this.contact_manifolds.first=i.next_manifold:o.next_manifold=i.next_manifold,i=i.next_manifold):(o=i,i=i.next_manifold)},t.NarrowPhase.prototype.midPhase=function(i,o){var e,s;i.shape instanceof t.CompoundShape?(e=i,s=o):(e=o,s=i);for(var a,n,r=t.ObjectPool.getObject("RigidBodyProxy"),c=0;e.shape.child_shapes.length>c;c++)if(a=e.shape.child_shapes[c],r.setFrom(e,a),r.shape instanceof t.CompoundShape||s.shape instanceof t.CompoundShape)this.midPhase(r,s);else if(n=this.getContact(r,s),null!=n){var h,l;if(n.object_a===r?(n.object_a=e,h=r,l=s):(n.object_b=e,h=s,l=r),h instanceof t.RigidBodyProxy)for(;h.parent;)h instanceof t.RigidBodyProxy&&h.shape_data.transform.transformVector3(n.contact_point_in_a),h=h.parent;if(l instanceof t.RigidBodyProxy)for(;l.parent;)l instanceof t.RigidBodyProxy&&l.shape_data.transform.transformVector3(n.contact_point_in_b),l=l.parent;n.object_a=h,n.object_b=l,this.addContact(h,l,n)}t.ObjectPool.freeObject("RigidBodyProxy",r)},t.NarrowPhase.prototype.getContact=function(i,o){if(i.shape instanceof t.CompoundShape||o.shape instanceof t.CompoundShape)return this.midPhase(i,o),void 0;var e;if(i.shape instanceof t.SphereShape&&o.shape instanceof t.SphereShape)e=t.SphereSphere(i,o);else if(i.shape instanceof t.SphereShape&&o.shape instanceof t.BoxShape||i.shape instanceof t.BoxShape&&o.shape instanceof t.SphereShape)e=t.BoxSphere(i,o);else{var s=t.GjkEpa.GJK(i,o);null!=t.GjkEpa.result?e=t.GjkEpa.result:null!=s&&(e=t.GjkEpa.EPA(s))}return e},t.NarrowPhase.prototype.addContact=function(t,i,o){this.contact_manifolds.getManifoldForObjects(t,i).addContact(o)},t.NarrowPhase.prototype.generateContacts=function(t){var i,o,e=t.length;for(this.updateContactManifolds(),i=0;e>i;i++)o=this.getContact(t[i][0],t[i][1]),null!=o&&this.addContact(t[i][0],t[i][1],o)},t.ObjectPool={types:{},pools:{},registerType:function(t,i){this.types[t]=i,this.pools[t]=[]},getObject:function(t){var i=this.pools[t];return 0!==i.length?i.pop():this.types[t]()},freeObject:function(t,i){null!=i.removeAllListeners&&i.removeAllListeners(),this.pools[t].push(i)}},t.ObjectPool.registerType("ContactDetails",function(){return new t.ContactDetails}),t.ObjectPool.registerType("ContactManifold",function(){return new t.ContactManifold}),t.ObjectPool.registerType("GJK2SupportPoint",function(){return new t.GjkEpa.SupportPoint(new t.Vector3,new t.Vector3,new t.Vector3)}),t.ObjectPool.registerType("ConstraintRow",function(){return new t.ConstraintRow}),t.ObjectPool.registerType("ContactConstraint",function(){return new t.ContactConstraint}),t.ObjectPool.registerType("FrictionConstraint",function(){return new t.FrictionConstraint}),t.ObjectPool.registerType("RayIntersection",function(){return new t.RayIntersection}),t.ObjectPool.registerType("RigidBodyProxy",function(){return new t.RigidBodyProxy}),t.RayIntersection=function(){this.object=null,this.point=new t.Vector3,this.t=null,this.normal=new t.Vector3},t.RigidBody=function(){var i=0;return function(o,e){this.id=i++,this.shape=o,this.aabb=new t.AABB,this.mass=e||1/0,this.position=new t.Vector3,this.rotation=new t.Quaternion(0,0,0,1),this.linear_velocity=new t.Vector3,this.angular_velocity=new t.Vector3,this.transform=new t.Matrix4,this.transform.identity(),this.transform_inverse=new t.Matrix4,this.transform_inverse.identity(),this.inertiaTensor=o.getInertiaTensor(e),this.inverseInertiaTensor=new t.Matrix3,this.inertiaTensor.invertInto(this.inverseInertiaTensor),this.inertiaTensorWorldFrame=new t.Matrix3,this.inverseInertiaTensorWorldFrame=new t.Matrix3,this.acceleration=new t.Vector3,this.restitution=.1,this.friction=.5,this.collision_groups=0,this.collision_mask=0,this.gravity=null,this.linear_damping=0,this.angular_damping=0,this.world=null,this.accumulated_force=new t.Vector3,this.accumulated_torque=new t.Vector3,this.push_velocity=new t.Vector3,this.turn_velocity=new t.Vector3,this.solver_impulse=new Float64Array(6),this.updateDerived(),this.listeners={}}}(),t.EventEmitter.apply(t.RigidBody),t.RigidBody.prototype.findSupportPoint=function(){var i=new t.Vector3;return function(t,o){this.transform_inverse.rotateVector3Into(t,i),this.shape.findSupportPoint(i,o),this.transform.transformVector3(o)}}(),t.RigidBody.prototype.rayIntersect=function(){var i=new t.Vector3,o=new t.Vector3;return function(t,e,s){this.transform_inverse.transformVector3Into(t,i),this.transform_inverse.transformVector3Into(e,o);var a=this.shape.rayIntersect(i,o);null!=a&&(a.object=this,this.transform.transformVector3(a.point),this.transform.rotateVector3(a.normal),s.push(a))}}(),t.RigidBody.prototype.integrate=function(t){if(1/0!==this.mass){var o=1/this.mass;i.scaleVector(this.accumulated_force,o),this.linear_velocity.add(i),this.inverseInertiaTensorWorldFrame.transformVector3Into(this.accumulated_torque,i),this.angular_velocity.add(i),this.linear_velocity.scale(Math.pow(1-this.linear_damping,t)),this.angular_velocity.scale(Math.pow(1-this.angular_damping,t)),i.scaleVector(this.linear_velocity,t),this.position.add(i),s.x=this.angular_velocity.x*t,s.y=this.angular_velocity.y*t,s.z=this.angular_velocity.z*t,s.w=0,s.multiply(this.rotation);var e=.5;this.rotation.x+=e*s.x,this.rotation.y+=e*s.y,this.rotation.z+=e*s.z,this.rotation.w+=e*s.w,this.rotation.normalize(),this.accumulated_force.x=this.accumulated_force.y=this.accumulated_force.z=0,this.accumulated_torque.x=this.accumulated_torque.y=this.accumulated_torque.z=0,this.solver_impulse[0]=this.solver_impulse[1]=this.solver_impulse[2]=this.solver_impulse[3]=this.solver_impulse[4]=this.solver_impulse[5]=0,this.push_velocity.x=this.push_velocity.y=this.push_velocity.z=0,this.turn_velocity.x=this.turn_velocity.y=this.turn_velocity.z=0}},t.RigidBody.prototype.setGravity=function(i,o,e){this.gravity?(this.gravity.x=i,this.gravity.y=o,this.gravity.z=e):this.gravity=new t.Vector3(i,o,e)},t.RigidBody.prototype.applyImpulse=function(t){this.linear_velocity.add(t)},t.RigidBody.prototype.applyForce=function(t){this.accumulated_force.add(t)},t.RigidBody.prototype.applyForceAtWorldPoint=function(t,o){i.copy(o),i.subtract(this.position),i.cross(t),this.accumulated_force.add(t),this.accumulated_torque.add(i)},t.RigidBody.prototype.applyForceAtLocalPoint=function(t,o){this.transform.transformVector3Into(o,i),this.applyForceAtWorldPoint(t,_vec3)},t.RigidBody.prototype.getVelocityInLocalPoint=function(t,i){1/0===this.mass?i.set(0,0,0):(i.copy(this.angular_velocity),i.cross(t),i.add(this.linear_velocity))
},t.RigidBody.prototype.updateDerived=function(){this.rotation.normalize(),this.transform.makeTransform(this.rotation,this.position),this.transform.invertInto(this.transform_inverse),1/0!==this.mass&&(n.fromMatrix4(this.transform_inverse),n.transposeInto(r),r.multiply(this.inertiaTensor),this.inertiaTensorWorldFrame.multiplyFrom(r,n),this.inertiaTensorWorldFrame.invertInto(this.inverseInertiaTensorWorldFrame)),this.aabb.transform(this.shape.aabb,this.transform)},t.RigidBodyProxy=function(){this.parent=null,this.id=null,this.shape=null,this.aabb=new t.AABB,this.mass=null,this.position=new t.Vector3,this.rotation=new t.Quaternion,this.transform=new t.Matrix4,this.transform_inverse=new t.Matrix4,this.restitution=null,this.friction=null},t.RigidBodyProxy.prototype.setFrom=function(t,i){this.parent=t,this.id=t.id,this.shape=i.shape,this.shape_data=i,this.mass=t.mass,t.transform.transformVector3Into(i.position,this.position),this.rotation.multiplyQuaternions(t.rotation,i.rotation),this.transform.makeTransform(this.rotation,this.position),this.transform.invertInto(this.transform_inverse),this.aabb.transform(this.shape.aabb,this.transform),this.restitution=t.restitution,this.friction=t.friction},t.RigidBodyProxy.prototype.findSupportPoint=t.RigidBody.prototype.findSupportPoint,t.RigidBodyProxy.prototype.getRigidBody=function(){for(var t=this.parent;t.parent;)t=this.parent;return t},t.BoxShape=function(i,o,e){this.half_width=i,this.half_height=o,this.half_depth=e,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb)},t.BoxShape.prototype.calculateLocalAABB=function(t){t.min.x=-this.half_width,t.min.y=-this.half_height,t.min.z=-this.half_depth,t.max.x=this.half_width,t.max.y=this.half_height,t.max.z=this.half_depth},t.BoxShape.prototype.getInertiaTensor=function(i){var o=4*this.half_height*this.half_height,e=4*this.half_width*this.half_width,s=4*this.half_depth*this.half_depth,a=.0833*i;return new t.Matrix3(a*(o+s),0,0,0,a*(e+s),0,0,0,a*(o+e))},t.BoxShape.prototype.findSupportPoint=function(t,i){i.x=0>t.x?-this.half_width:this.half_width,i.y=0>t.y?-this.half_height:this.half_height,i.z=0>t.z?-this.half_depth:this.half_depth},t.BoxShape.prototype.rayIntersect=function(){var i,o,e,s,a,n,r,c=new t.Vector3;return function(h,l){i=0,c.subtractVectors(l,h),o=c.length(),c.scale(1/o);for(var p=0;3>p;p++){if(e=0===p?"x":1===p?"y":"z",r=0===p?this.half_width:1===p?this.half_height:this.half_depth,Math.abs(c[e])<t.EPSILON&&(-r>h[e]||h[e]>r))return null;if(s=1/c[e],a=(-r-h[e])*s,n=(r-h[e])*s,a>n&&(s=a,a=n,n=s),i=Math.max(i,a),o=Math.min(o,n),i>o)return null}var _=t.ObjectPool.getObject("RayIntersection");_.object=this,_.t=i,_.point.scaleVector(c,i),_.point.add(h);var b=1/0;for(p=0;3>p;p++)e=0===p?"x":1===p?"y":"z",r=0===p?this.half_width:1===p?this.half_height:this.half_depth,b>r-Math.abs(_.point[e])&&(_.normal.x=_.normal.y=_.normal.z=0,_.normal[e]=0>_.point[e]?-1:1,b=r-Math.abs(_.point[e]));return _}}(),t.CompoundShape=function(){this.child_shapes=[],this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb)},t.CompoundShape.prototype.addChildShape=function(i,o,e){this.child_shapes.push(new t.CompoundShapeChild(i,o,e)),this.calculateLocalAABB(this.aabb)},t.CompoundShape.prototype.calculateLocalAABB=function(t){t.min.x=t.min.y=t.min.z=1/0,t.max.x=t.max.y=t.max.z=-1/0;var i,o;for(i=0;this.child_shapes.length>i;i++)o=this.child_shapes[i],t.min.x=Math.min(t.min.x,o.aabb.min.x),t.min.y=Math.min(t.min.y,o.aabb.min.y),t.min.z=Math.min(t.min.z,o.aabb.min.z),t.max.x=Math.max(t.max.x,o.aabb.max.x),t.max.y=Math.max(t.max.y,o.aabb.max.y),t.max.z=Math.max(t.max.z,o.aabb.max.z)},t.CompoundShape.prototype.getInertiaTensor=function(o){var e,s,a,c=new t.Matrix3,h=new t.Matrix3;for(c.identity(),o/=this.child_shapes.length,i.x=i.y=i.z=0,e=0;this.child_shapes.length>e;e++)s=this.child_shapes[e],i.subtract(s.position),h.e00=o*-(i.y*i.y+i.z*i.z),h.e10=o*i.x*i.y,h.e20=o*i.x*i.z,h.e01=o*i.x*i.y,h.e11=o*-(i.x*i.x+i.z*i.z),h.e21=o*i.y*i.z,h.e02=o*i.x*i.z,h.e12=o*i.y*i.z,h.e22=o*-(i.x*i.x+i.y*i.y),n.fromMatrix4(s.transform),a=s.shape.getInertiaTensor(o),n.transposeInto(r),n.multiply(a),n.multiply(r),c.e00+=n.e00+h.e00,c.e10+=n.e10+h.e10,c.e20+=n.e20+h.e20,c.e01+=n.e01+h.e01,c.e11+=n.e11+h.e11,c.e21+=n.e21+h.e21,c.e02+=n.e02+h.e02,c.e12+=n.e12+h.e12,c.e22+=n.e22+h.e22;return c},t.CompoundShape.prototype.rayIntersect=function(){var i=function(t,i){return t.t<i.t?-1:t.t>i.t?1:0};return function(o,e){var s,a,n,r=[],c=new t.Vector3,h=new t.Vector3;for(a=0;this.child_shapes.length>a;a++)n=this.child_shapes[a],n.transform_inverse.transformVector3Into(o,c),n.transform_inverse.transformVector3Into(e,h),s=n.shape.rayIntersect(c,h),null!=s&&(s.object=this,n.transform.transformVector3(s.point),r.push(s));return r.sort(i),r[0]||null}}(),t.CompoundShapeChild=function(i,o,e){this.shape=i,this.position=new t.Vector3(o.x,o.y,o.z),this.rotation=new t.Quaternion(e.x,e.y,e.z,e.w),this.transform=new t.Matrix4,this.transform_inverse=new t.Matrix4,this.transform.makeTransform(this.rotation,this.position),this.transform.invertInto(this.transform_inverse),this.aabb=new t.AABB,this.aabb.transform(this.shape.aabb,this.transform)},t.ConeShape=function(i,o){this.radius=i,this.half_height=o,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb),this._sinangle=this.radius/Math.sqrt(this.radius*this.radius+Math.pow(2*this.half_height,2)),this._cosangle=Math.cos(Math.asin(this._sinangle))},t.ConeShape.prototype.calculateLocalAABB=function(t){t.min.x=t.min.z=-this.radius,t.min.y=-this.half_height,t.max.x=t.max.z=this.radius,t.max.y=this.half_height},t.ConeShape.prototype.getInertiaTensor=function(i){var o=.1*i*Math.pow(2*this.half_height,2)+.15*i*this.radius*this.radius;return new t.Matrix3(o,0,0,0,.3*i*this.radius*this.radius,0,0,0,o)},t.ConeShape.prototype.findSupportPoint=function(t,i){var o=Math.sqrt(t.x*t.x+t.z*t.z);if(t.y>t.length()*this._sinangle)i.x=i.z=0,i.y=this.half_height;else if(o>0){var e=this.radius/o;i.x=e*t.x,i.y=-this.half_height,i.z=e*t.z}else i.x=i.z=0,i.y=-this.half_height},t.ConeShape.prototype.rayIntersect=function(){var i,o=new t.Vector3,e=new t.Vector3,s=new t.Vector3,a=new t.Vector3,n=new t.Vector3;return function(r,c){o.subtractVectors(c,r),i=o.length(),o.scale(1/i);var h,l;e.x=e.y=e.z=0,h=this._rayIntersectBase(r,c,e,a),s.x=s.y=s.z=0,l=this._rayIntersectCone(r,o,i,s,n);var p;return h||l?!l||h&&l>h?(p=t.ObjectPool.getObject("RayIntersection"),p.object=this,p.t=h,p.point.copy(e),p.normal.copy(a),p):!h||l&&h>l?(p=t.ObjectPool.getObject("RayIntersection"),p.object=this,p.t=l,p.point.copy(s),p.normal.copy(n),p):null:null}}(),t.ConeShape.prototype._rayIntersectBase=function(){var i,o=new t.Vector3(0,-1,0),e=new t.Vector3,s=new t.Vector3,a=new t.Vector3;return function(t,n,r,c){return s.x=t.x,s.y=t.y+this.half_height,s.z=t.z,a.x=n.x,a.y=n.y+this.half_height,a.z=n.z,e.subtractVectors(a,s),i=-o.dot(s)/o.dot(e),0>i||i>1?null:(r.scaleVector(e,i),r.add(t),r.x*r.x+r.z*r.z>this.radius*this.radius?null:(c.x=c.z=0,c.y=-1,i*e.length()))}}(),t.ConeShape.prototype._rayIntersectCone=function(){var o=new t.Vector3;return function(e,s,a,n,r){var c=new t.Vector3(0,-1,0),h=c.dot(s),l=this._cosangle*this._cosangle,p=new t.Vector3;p.x=e.x,p.y=e.y-this.half_height,p.z=e.z;var _,b,u=c.dot(p),f=s.dot(p),d=p.dot(p),m=h*h-l,y=h*u-l*f,j=u*u-l*d,w=null;if(Math.abs(m)>=t.EPSILON){var x=y*y-j*m;if(-t.EPSILON>x)return null;if(x>t.EPSILON){var v=Math.sqrt(x),g=1/m;if(b=(-y-v)*g,b>=0&&a>=b&&(o.scaleVector(s,b),o.add(e),p.y=o.y-this.half_height,_=p.dot(c),_>=0&&(w=b,n.copy(o))),b=(-y+v)*g,b>=0&&a>=b&&(null==w||w>b)&&(o.scaleVector(s,b),o.add(e),p.y=o.y-this.half_height,_=p.dot(c),_>=0&&(w=b,n.copy(o))),null==w)return null;w/=a}else{if(b=-y/m,o.scaleVector(s,b),o.add(e),p.y=o.y-this.half_height,_=p.dot(c),0>_)return null;if(i.subtractVectors(o,e),i.lengthSquared()>a*a)return null;w=b/a,n.copy(o)}}else{if(!(Math.abs(y)>=t.EPSILON))return null;if(b=.5*j/y,o.scaleVector(s,b),o.add(e),p.y=o.y-this.half_height,_=p.dot(c),0>_)return null;w=b,n.copy(o)}return n.y<-this.half_height?null:(r.x=n.x,r.y=0,r.z=n.z,r.normalize(),r.x*=2*this.half_height/this.radius,r.y=this.radius/(2*this.half_height),r.z*=2*this.half_height/this.radius,r.normalize(),w*a)}}(),t.ConvexShape=function(i){this.vertices=[],this.faces=[],this.volume=0,this.center_of_mass=new t.Vector3,this._integral=new Float32Array(10),this.process(i),this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb)},t.ConvexShape.prototype.process=function(e){for(var s=e.slice(),a=null,n=null,r=0;s.length>r;r++){var c=s[r];(null==a||a.x>c.x)&&(a=c),(null==n||n.x>c.x)&&(n=c)}a===n&&(n=e[0]===a?e[1]:e[0]);var h=a,l=n;s.splice(s.indexOf(h),1),s.splice(s.indexOf(l),1);var p,_,b=-1/0,u=null;for(r=0;s.length>r;r++)p=s[r],_=t.GeometryMethods.findSquaredDistanceFromSegment(p,h,l),_>b&&(b=_,u=r);var f=s[u];for(s.splice(u,1),i.subtractVectors(l,h),o.subtractVectors(f,h),i.cross(o),b=-1/0,u=null,r=0;s.length>r;r++)p=s[r],_=Math.abs(i.dot(p)),_>b&&(b=_,u=r);var d=s[u];if(s.splice(u,1),i.dot(d)>0){var m=h;h=f,f=m}var y=new t.GjkEpa.Polyhedron({points:[{point:f},{point:l},{point:h},{point:d}]});for(r=0;s.length>r;r++){y.closest_face=null;for(var j=0;y.faces.length>j;j++)if(y.faces[j].active===!0&&y.faces[j].classifyVertex({point:s[r]})>0){y.closest_face=j;break}null!=y.closest_face&&y.addVertex({point:s[r]})}this.faces=y.faces.filter(function(t){return t.active});var w=this;this.faces.forEach(function(t){var i=t.a.point,o=t.b.point,e=t.c.point,s=w.vertices.indexOf(i),a=w.vertices.indexOf(o),n=w.vertices.indexOf(e);-1===s&&w.vertices.push(i),-1===a&&w.vertices.push(o),-1===n&&w.vertices.push(e)}),this.computeVolume()},t.ConvexShape.prototype.calculateLocalAABB=function(t){t.min.x=t.min.y=t.min.z=0,t.max.x=t.max.y=t.max.z=0;for(var i=0;this.vertices.length>i;i++)t.min.x=Math.min(t.min.x,this.vertices[i].x),t.min.y=Math.min(t.min.y,this.vertices[i].y),t.min.z=Math.min(t.min.z,this.vertices[i].z),t.max.x=Math.max(t.max.x,this.vertices[i].x),t.max.y=Math.max(t.max.y,this.vertices[i].y),t.max.z=Math.max(t.max.z,this.vertices[i].z)},t.ConvexShape.prototype.computeVolume=function(){var t=new Float32Array(6),i=function(i,o,e){var s=i+o,a=i*i,n=a+o*s;t[0]=s+e,t[1]=n+e*t[0],t[2]=i*a+o*n+e*t[1],t[3]=t[1]+i*(t[0]+i),t[4]=t[1]+o*(t[0]+o),t[5]=t[1]+e*(t[0]+e)};return function(){for(var o=0;this.faces.length>o;o++){var e=this.faces[o],s=e.a.point,a=e.b.point,n=e.c.point,r=a.x-s.x,c=a.y-s.y,h=a.z-s.z,l=n.x-s.x,p=n.y-s.y,_=n.z-s.z,b=c*_-p*h,u=l*h-r*_,f=r*p-l*c;i(s.x,a.x,n.x);var d=t[0],m=t[1],y=t[2],j=t[3],w=t[4],x=t[5];i(s.y,a.y,n.y);var v=(t[0],t[1]),g=t[2],z=t[3],V=t[4],B=t[5];i(s.z,a.z,n.z);var S=(t[0],t[1]),C=t[2],P=t[3],O=t[4],I=t[5];this._integral[0]+=b*d,this._integral[1]+=b*m,this._integral[2]+=u*v,this._integral[3]+=f*S,this._integral[4]+=b*y,this._integral[5]+=u*g,this._integral[6]+=f*C,this._integral[7]+=b*(s.y*j+a.y*w+n.y*x),this._integral[8]+=u*(s.z*z+a.z*V+n.z*B),this._integral[9]+=f*(s.x*P+a.x*O+n.x*I)}this._integral[0]*=1/6,this._integral[1]*=1/24,this._integral[2]*=1/24,this._integral[3]*=1/24,this._integral[4]*=1/60,this._integral[5]*=1/60,this._integral[6]*=1/60,this._integral[7]*=1/120,this._integral[8]*=1/120,this._integral[9]*=1/120,this.volume=this._integral[0],this.center_of_mass.x=this._integral[1]/this.volume,this.center_of_mass.y=this._integral[2]/this.volume,this.center_of_mass.z=this._integral[3]/this.volume}}(),t.ConvexShape.prototype.getInertiaTensor=function(){return function(i){var o=new t.Matrix3;return o.e00=(this._integral[5]+this._integral[6])*i,o.e11=(this._integral[4]+this._integral[6])*i,o.e22=(this._integral[4]+this._integral[5])*i,o.e10=o.e01=-this._integral[7]*i,o.e21=o.e12=-this._integral[8]*i,o.e20=o.e02=-this._integral[9]*i,o.e00-=i*(this.center_of_mass.y*this.center_of_mass.y+this.center_of_mass.z*this.center_of_mass.z),o.e11-=i*(this.center_of_mass.x*this.center_of_mass.x+this.center_of_mass.z*this.center_of_mass.z),o.e22-=i*(this.center_of_mass.x*this.center_of_mass.x+this.center_of_mass.y*this.center_of_mass.y),o.e10+=i*this.center_of_mass.x*this.center_of_mass.y,o.e01+=i*this.center_of_mass.x*this.center_of_mass.y,o.e21+=i*this.center_of_mass.y*this.center_of_mass.z,o.e12+=i*this.center_of_mass.y*this.center_of_mass.z,o.e20+=i*this.center_of_mass.x*this.center_of_mass.z,o.e02+=i*this.center_of_mass.x*this.center_of_mass.z,o}}(),t.ConvexShape.prototype.findSupportPoint=function(t,i){for(var o,e,s=-1/0,a=0;this.vertices.length>a;a++)e=this.vertices[a].dot(t),e>s&&(s=e,o=a);i.copy(this.vertices[o])},t.ConvexShape.prototype.rayIntersect=function(){var i,o,e=new t.Vector3,s=new t.Vector3,a=new t.Vector3,n=new t.Vector3,r=new t.Vector3,c=new t.Vector3;return new t.Vector3,new t.Vector3,function(h,l){i=0,e.subtractVectors(l,h),o=e.length(),e.scale(1/o);for(var p=0;this.faces.length>p;p++){var _=this.faces[p];s.subtractVectors(_.b.point,_.a.point),a.subtractVectors(_.c.point,_.a.point),n.crossVectors(e,a);var b=s.dot(n);if(!(t.EPSILON>b)){var u=1/b;r.subtractVectors(h,_.a.point);var f=u*r.dot(n);if(!(0>f)){c.crossVectors(r,s);var d=u*e.dot(c);if(!(0>d||f+d>1)){var m=u*a.dot(c);if(!(i>m||m>o)){var y=t.ObjectPool.getObject("RayIntersection");return y.object=this,y.t=m,y.point.scaleVector(e,m),y.point.add(h),y.normal.copy(_.normal),y}}}}}return null}}(),t.CylinderShape=function(i,o){this.radius=i,this.half_height=o,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb)},t.CylinderShape.prototype.calculateLocalAABB=function(t){t.min.x=t.min.z=-this.radius,t.min.y=-this.half_height,t.max.x=t.max.z=this.radius,t.max.y=this.half_height},t.CylinderShape.prototype.getInertiaTensor=function(i){var o=.0833*i*(3*this.radius*this.radius+(this.half_height+this.half_height)*(this.half_height+this.half_height));return new t.Matrix3(o,0,0,0,.5*i*this.radius*this.radius,0,0,0,o)},t.CylinderShape.prototype.findSupportPoint=function(t,i){if(i.y=0>t.y?-this.half_height:this.half_height,0===t.x&&0===t.z)i.x=i.z=0;else{var o=Math.sqrt(t.x*t.x+t.z*t.z),e=this.radius/o;i.x=e*t.x,i.z=e*t.z}},t.CylinderShape.prototype.rayIntersect=function(){var i=new t.Vector3,o=new t.Vector3;return function(e,s){i.y=this.half_height,o.y=-this.half_height;var a=new t.Vector3;a.subtractVectors(o,i);var n=new t.Vector3;n.subtractVectors(e,i);var r=new t.Vector3;r.subtractVectors(s,e);var c=n.dot(a),h=r.dot(a),l=a.dot(a);if(0>c&&0>c+h)return null;if(c>l&&c+h>l)return null;var p,_,b=r.dot(r),u=n.dot(r),f=l*b-h*h,d=n.dot(n)-this.radius*this.radius,m=l*d-c*c;if(Math.abs(f)<t.EPSILON){if(m>0)return null;p=0>c?-u/b:c>l?(h-u)/b:0}else{var y=l*u-h*c,j=y*y-f*m;if(0>j)return null;if(_=p=(-y-Math.sqrt(j))/f,0>c+p*h){if(0>=h)return null;if(p=-c/h,!(0>=d+p*(2*u+p*b)))return null;_=p}else if(c+p*h>l){if(h>=0)return null;if(p=(l-c)/h,!(0>=d+l-2*c+p*(2*(u-h)+p*b)))return null;_=p}if(p=_,0>p||p>1)return null}var w=t.ObjectPool.getObject("RayIntersection");return w.object=this,w.t=p*r.length(),w.point.scaleVector(r,p),w.point.add(e),Math.abs(w.point.y-this.half_height)<=t.EPSILON?(w.normal.x=w.normal.z=0,w.normal.y=0>w.point.y?-1:1):(w.normal.y=0,w.normal.x=w.point.x,w.normal.z=w.point.z,w.normal.scale(1/this.radius)),w}}(),t.PlaneShape=function(i,o,e){this.orientation=i,this.half_width=o,this.half_length=e,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb),0===this.orientation?(this._half_width=0,this._half_height=this.half_width,this._half_depth=this.half_length):1===this.orientation?(this._half_width=this.half_width,this._half_height=0,this._half_depth=this.half_length):(this._half_width=this.half_width,this._half_height=this.half_length,this._half_depth=0)},t.PlaneShape.prototype.calculateLocalAABB=function(t){0===this.orientation?(this._half_width=0,this._half_height=this.half_width,this._half_depth=this.half_length,t.min.x=0,t.min.y=-this.half_width,t.min.z=-this.half_length,t.max.x=0,t.max.y=this.half_width,t.max.z=this.half_length):1===this.orientation?(this._half_width=this.half_width,this._half_height=0,this._half_depth=this.half_length,t.min.x=-this.half_width,t.min.y=0,t.min.z=-this.half_length,t.max.x=this.half_width,t.max.y=0,t.max.z=this.half_length):(this._half_width=this.half_width,this._half_height=this.half_length,this._half_depth=0,t.min.x=-this.half_width,t.min.y=-this.half_length,t.min.z=0,t.max.x=this.half_width,t.max.y=this.half_length,t.max.z=0)},t.PlaneShape.prototype.getInertiaTensor=function(i){var o=4*this.half_width*this.half_width,e=4*this.half_length*this.half_length,s=.0833*i,a=s*e,n=s*(o+e),r=s*o;return 0===this.orientation?new t.Matrix3(n,0,0,0,a,0,0,0,r):1===this.orientation?new t.Matrix3(a,0,0,0,n,0,0,0,r):new t.Matrix3(n,0,0,0,r,0,0,0,a)},t.PlaneShape.prototype.findSupportPoint=function(t,i){i.x=0>t.x?-this._half_width:this._half_width,i.y=0>t.y?-this._half_height:this._half_height,i.z=0>t.z?-this._half_depth:this._half_depth},t.PlaneShape.prototype.rayIntersect=function(){var i,o=new t.Vector3,e=new t.Vector3,s=new t.Vector3;return function(a,n){if(0===this.orientation?(o.x=1,o.y=o.z=0):1===this.orientation?(o.y=1,o.x=o.z=0):(o.z=1,o.x=o.y=0),e.subtractVectors(n,a),i=-o.dot(a)/o.dot(e),0>i||i>1)return null;if(s.scaleVector(e,i),s.add(a),s.x<-this._half_width||s.x>this._half_width)return null;if(s.y<-this._half_height||s.y>this._half_height)return null;if(s.z<-this._half_depth||s.z>this._half_depth)return null;var r=t.ObjectPool.getObject("RayIntersection");return r.object=this,r.t=i*e.length(),r.point.copy(s),r.normal.copy(o),r}}(),t.SphereShape=function(i){this.radius=i,this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb)},t.SphereShape.prototype.calculateLocalAABB=function(t){t.min.x=t.min.y=t.min.z=-this.radius,t.max.x=t.max.y=t.max.z=this.radius},t.SphereShape.prototype.getInertiaTensor=function(i){var o=.4*i*this.radius*this.radius;return new t.Matrix3(o,0,0,0,o,0,0,0,o)},t.SphereShape.prototype.findSupportPoint=function(){var i=new t.Vector3;return function(t,o){i.normalizeVector(t),o.scaleVector(i,this.radius)}}(),t.SphereShape.prototype.rayIntersect=function(){var i,o=new t.Vector3;return function(e,s){o.subtractVectors(s,e),i=o.length(),o.scale(1/i);var a=e.dot(o),n=e.dot(e)-this.radius*this.radius;if(a>=0&&n>=0)return null;var r=a*a-n;if(0>r)return null;var c=Math.sqrt(r),h=-a-c;if(0>h&&(h=-a+c),h>i)return null;var l=t.ObjectPool.getObject("RayIntersection");return l.object=this,l.point.scaleVector(o,h),l.t=h,l.point.add(e),l.normal.normalizeVector(l.point),l}}(),t.LineSweptShape=function(i,o,e){this.start=i,this.end=o,this.shape=e,this.direction=new t.Vector3,this.direction.subtractVectors(o,i),this.length=this.direction.length(),this.direction.normalize(),this.aabb=new t.AABB,this.calculateLocalAABB(this.aabb)},t.LineSweptShape.prototype.calculateLocalAABB=function(t){this.shape.calculateLocalAABB(t),t.min.x=Math.min(t.min.x+this.start.x,t.min.x+this.end.x),t.min.y=Math.min(t.min.y+this.start.y,t.min.y+this.end.y),t.min.z=Math.min(t.min.z+this.start.z,t.min.z+this.end.z),t.max.x=Math.max(t.max.x+this.start.x,t.max.x+this.end.x),t.max.y=Math.max(t.max.y+this.start.y,t.max.y+this.end.y),t.max.z=Math.max(t.max.z+this.start.z,t.max.z+this.end.z)},t.LineSweptShape.prototype.getInertiaTensor=function(t){return this.shape.getInertiaTensor(t)},t.LineSweptShape.prototype.findSupportPoint=function(t,i){this.shape.findSupportPoint(t,i);var o=this.direction.dot(t);0>o?i.add(this.start):i.add(this.end)},t.LineSweptShape.prototype.rayIntersect=function(){return null},t.GeometryMethods={findClosestPointInTriangle:function(){var i=new t.Vector3,o=new t.Vector3,e=new t.Vector3;return function(t,s,a,n,r){var c;i.subtractVectors(a,s),o.subtractVectors(n,s),e.subtractVectors(t,s);var h=i.dot(e),l=o.dot(e);if(0>=h&&0>=l)return r.copy(s),void 0;e.subtractVectors(t,a);var p=i.dot(e),_=o.dot(e);if(p>=0&&p>=_)return r.copy(a),void 0;var b=h*_-p*l;if(0>=b&&h>=0&&0>=p)return c=h/(h-p),r.scaleVector(i,c),r.add(s),void 0;e.subtractVectors(t,n);var u=i.dot(e),f=o.dot(e);if(f>=0&&f>=u)return r.copy(n),void 0;var d,m=u*l-h*f;if(0>=m&&l>=0&&0>=f)return d=l/(l-f),r.scaleVector(o,d),r.add(s),void 0;var y=p*f-u*_;if(0>=y&&_-p>=0&&u-f>=0)return d=(_-p)/(_-p+(u-f)),r.subtractVectors(n,a),r.scale(d),r.add(a),void 0;var j=1/(y+m+b);c=m*j,d=b*j,i.scale(c),i.add(s),o.scale(d),r.addVectors(i,o)}}(),findBarycentricCoordinates:function(i,o,e,s,a){var n=new t.Vector3,r=new t.Vector3,c=new t.Vector3;n.subtractVectors(e,o),r.subtractVectors(s,o),c.subtractVectors(i,o);var h=n.dot(n),l=n.dot(r),p=r.dot(r),_=c.dot(n),b=c.dot(r),u=h*p-l*l;a.y=(p*_-l*b)/u,a.z=(h*b-l*_)/u,a.x=1-a.y-a.z},findSquaredDistanceFromSegment:function(){var i=new t.Vector3,o=new t.Vector3,e=new t.Vector3;return function(t,s,a){i.subtractVectors(s,a),o.subtractVectors(s,t),e.subtractVectors(a,t);var n=o.dot(i);if(0>=n)return o.dot(o);var r=i.dot(i);return n>=r?e.dot(e):o.dot(o)-n*n/r}}()},t.World=function(i,o,e){this.ticks=0,this.broadphase=i,this.narrowphase=o,this.solver=e,e.world=this,this.rigid_bodies=[],this.gravity=new t.Vector3(0,-9.8,0),this.force_generators=[],this.listeners={}},t.EventEmitter.apply(t.World),t.World.prototype.step=function(t,o){o=o||t;var e,s,a,n,r,c;for(a=t/o,e=0;a>e;e++){for(this.ticks++,s=Math.min(o,t),t-=o,this.emit("stepStart",this.ticks,s),n=0,r=this.rigid_bodies.length;r>n;n++)this.rigid_bodies[n].updateDerived();for(n=0,r=this.rigid_bodies.length;r>n;n++)c=this.rigid_bodies[n],1/0!==c.mass&&(i.scaleVector(c.gravity||this.gravity,c.mass*s),c.accumulated_force.add(i));for(n=0,r=this.force_generators.length;r>n;n++)this.force_generators[n].applyForce();for(this.broadphase.predictContactPairs(),this.narrowphase.generateContacts(this.broadphase.collision_pairs),this.solver.processContactManifolds(this.narrowphase.contact_manifolds),this.solver.prepareConstraints(s),this.solver.resolveContacts(),this.solver.solveConstraints(),this.solver.applyConstraints(s),n=0,r=this.rigid_bodies.length;r>n;n++)c=this.rigid_bodies[n],c.integrate(s);this.emit("stepEnd",this.ticks,s)}},t.World.prototype.addRigidBody=function(t){t.world=this,t.updateDerived(),this.rigid_bodies.push(t),this.broadphase.addBody(t)},t.World.prototype.removeRigidBody=function(t){var i,o=this.rigid_bodies.length;for(i=0;o>i;i++)if(this.rigid_bodies[i]===t){this.rigid_bodies.splice(i,1),this.broadphase.removeBody(t);break}},t.World.prototype.addForceGenerator=function(t){var i,o;for(i=0,o=this.force_generators.length;o>i;i++)if(this.force_generators[i]===t)return;this.force_generators.push(t)},t.World.prototype.removeForceGenerator=function(t){var i,o;for(i=0,o=this.force_generators.length;o>i;i++)if(this.force_generators[i]===t)return this.force_generators.splice(i,1),void 0},t.World.prototype.addConstraint=function(t){this.solver.addConstraint(t)},t.World.prototype.removeConstraint=function(t){this.solver.removeConstraint(t)},function(){var i=function(t,i){return t.t<i.t?-1:t.t>i.t?1:0};t.World.prototype.rayIntersect=function(t,o){var e=this.broadphase.rayIntersect(t,o);return e.sort(i),e},t.World.prototype.shapeIntersect=function(o,e,s){var a=new t.LineSweptShape(e,s,o),n=new t.RigidBody(a,0);n.updateDerived();for(var r=this.broadphase.intersectsWith(n),c=[],h=0;r.length>h;h++){var l=this.narrowphase.getContact(n,r[h]);if(null!=l){var p=t.ObjectPool.getObject("RayIntersection");p.object=l.object_b,p.normal.copy(l.contact_normal),p.point.scaleVector(l.contact_normal,-l.penetration_depth),p.point.add(l.contact_point),p.t=p.point.distanceTo(e),c.push(p)}}return c.sort(i),c}}(),"undefined"!=typeof window&&(window.Goblin=t),"undefined"!=typeof module&&(module.exports=t)})();